<!DOCTYPE html>
<html lang="zh-TW" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://wen-yuh-jywe.github.io/pic/JWY_logo.png">
    <link rel="shortcut icon" href="https://wen-yuh-jywe.github.io/pic/JWY_logo.png" type="image/x-icon">
    <title>NTU ISDM Server Reservation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            50: '#171717',
                            100: '#1E1E1E',
                            200: '#2D2D2D',
                            300: '#404040',
                            400: '#525252',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;600&family=Noto+Sans+TC:wght@350;600&display=swap');

        * {
            font-family: 'Noto Sans TC', sans-serif;
        }

        .page-transition {
            transition: all 0.3s ease-in-out;
        }

        .page-enter {
            opacity: 0;
            transform: translateY(20px);
        }

        .page-enter-active {
            opacity: 1;
            transform: translateY(0);
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1E1E1E;
        }

        ::-webkit-scrollbar-thumb {
            background: #4B5563;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6B7280;
        }

        #loadingOverlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            font-size: 1.2em;
            transition: opacity 0.3s ease-in-out;
        }

        #loadingOverlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .calendar-cell {
            min-height: 60px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .calendar-cell:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }

        .calendar-cell.reserved {
            background-color: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.4);
        }

        .calendar-header {
            min-width: 120px;
        }

        .time-slot {
            height: 60px;
        }

        .reservation-badge {
            background-color: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.4);
            padding: 2px 6px;
            font-size: 0.75rem;
            border-radius: 4px;
            margin: 2px 0;
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .reservation-badge:hover {
            background-color: rgba(59, 130, 246, 0.3);
        }

        #loginContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
            padding: 0 1.5em;
        }

        #mainContent {
            display: none;
        }

        .google-login-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 10px 16px;
            background-color: white;
            color: #444;
            border-radius: 8px;
            font-weight: 500;
            margin-top: 20px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }

        .google-login-btn:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-profile img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }
    </style>
</head>

<body class="bg-dark-100 text-gray-200">

    <div id="loadingOverlay" class="backdrop-blur">
        <span>正在載入，請稍候...</span>
    </div>

    <!-- 登入畫面 -->
    <div id="loginContainer" class="page-transition">
        <img src="https://wen-yuh-jywe.github.io/pic/JWY_logo.png" alt="ServerReservation" class="h-20 w-20 mb-4">
        <h1 class="text-2xl font-semibold text-gray-100 mb-6">NTU ISDM<br>Server Reservation</h1>
        <button id="googleLoginBtn" class="google-login-btn">
            <svg width="20" height="20" viewBox="0 0 24 24">
                <path fill="#EA4335"
                    d="M5.26620003,9.76452941 C6.19878754,6.93863203 8.85444915,4.90909091 12,4.90909091 C13.6909091,4.90909091 15.2181818,5.50909091 16.4181818,6.49090909 L19.9090909,3 C17.7818182,1.14545455 15.0545455,0 12,0 C7.27006974,0 3.1977497,2.69829785 1.23999023,6.65002441 L5.26620003,9.76452941 Z" />
                <path fill="#34A853"
                    d="M16.0407269,18.0125889 C14.9509167,18.7163016 13.5660892,19.0909091 12,19.0909091 C8.86648613,19.0909091 6.21911939,17.076871 5.27698177,14.2678769 L1.23746264,17.3349879 C3.19279051,21.2970142 7.26500293,24 12,24 C14.9328362,24 17.7353462,22.9573905 19.834192,20.9995801 L16.0407269,18.0125889 Z" />
                <path fill="#4A90E2"
                    d="M19.834192,20.9995801 C22.0291676,18.9520994 23.4545455,15.903663 23.4545455,12 C23.4545455,11.2909091 23.3454545,10.5272727 23.1818182,9.81818182 L12,9.81818182 L12,14.4545455 L18.4363636,14.4545455 C18.1187732,16.013626 17.2662994,17.2212117 16.0407269,18.0125889 L19.834192,20.9995801 Z" />
                <path fill="#FBBC05"
                    d="M5.27698177,14.2678769 C5.03832634,13.556323 4.90909091,12.7937589 4.90909091,12 C4.90909091,11.2182781 5.03443647,10.4668121 5.26620003,9.76452941 L1.23999023,6.65002441 C0.43658717,8.26043162 0,10.0753848 0,12 C0,13.9195484 0.444780743,15.7301709 1.23746264,17.3349879 L5.27698177,14.2678769 Z" />
            </svg>
            Google 登入
        </button>
        <p class="text-gray-500 mt-8 max-w-md">請使用經授權的 Google 帳號登入預約系統</p>

    </div>

    <!-- 主內容區域 -->
    <div id="mainContent">
        <nav class="bg-dark-50 border-b border-dark-300">
            <div class="mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <a href="#" class="flex items-center">
                            <img src="https://wen-yuh-jywe.github.io/pic/JWY_logo.png" alt="ServerReservation"
                                class="h-8 w-8 mr-2">
                            <h1 class="text-xl font-semibold text-gray-100">Server 預約系統</h1>
                        </a>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div id="userProfile" class="user-profile">
                        </div>
                        <button id="logoutBtn"
                            class="text-sm text-blue-400 hover:text-blue-300 transition duration-150 ease-in-out px-3 py-2 leading-none border border-blue-400/50 rounded">
                            登出
                        </button>
                    </div>
                </div>
            </div>
        </nav>
        <div id="statusIndicator" class="status-indicator"></div>

        <!-- 預約表單 Modal -->
        <div id="reservationModal"
            class="fixed inset-0 bg-black bg-opacity-50 hidden z-1 flex items-center justify-center transition-opacity duration-500 opacity-0 backdrop-blur">
            <div class="bg-dark-100 text-gray-200 m-3 p-6 rounded-lg shadow-lg max-w-md w-full transform scale-95 transition-all duration-300 opacity-0"
                id="reservationBox">
                <h3 class="text-lg font-semibold mb-4" id="reservationTitle">新增預約</h3>
                <form id="reservationForm" class="space-y-4">
                    <input type="hidden" id="reservationId" value="">
                    <input type="hidden" id="reservationCreator" value="">
                    <div>
                        <label for="userName" class="block text-sm font-medium text-gray-300 mb-1">使用人姓名 <span
                                class="text-red-500">*</span></label>
                        <input type="text" id="userName" name="userName" required
                            class="w-full bg-dark-200 border border-dark-300 rounded-md py-2 px-3 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="serverSelect" class="block text-sm font-medium text-gray-300 mb-1">選擇 Server <span
                                class="text-red-500">*</span></label>
                        <select id="serverSelect" name="serverSelect" required
                            class="w-full bg-dark-200 border border-dark-300 rounded-md py-2 px-3 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </select>
                    </div>
                    <div>
                        <label for="reservationDate" class="block text-sm font-medium text-gray-300 mb-1">預約日期 <span
                                class="text-red-500">*</span></label>
                        <input type="date" id="reservationDate" name="reservationDate" required
                            class="w-full bg-dark-200 border border-dark-300 rounded-md py-2 px-3 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="startTime" class="block text-sm font-medium text-gray-300 mb-1">開始時間 <span
                                    class="text-red-500">*</span></label>
                            <select id="startTime" name="startTime" required
                                class="w-full bg-dark-200 border border-dark-300 rounded-md py-2 px-3 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </select>
                        </div>
                        <div>
                            <label for="endTime" class="block text-sm font-medium text-gray-300 mb-1">結束時間 <span
                                    class="text-red-500">*</span></label>
                            <select id="endTime" name="endTime" required
                                class="w-full bg-dark-200 border border-dark-300 rounded-md py-2 px-3 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="notes" class="block text-sm font-medium text-gray-300 mb-1">備註</label>
                        <textarea id="notes" name="notes" rows="3"
                            class="w-full bg-dark-200 border border-dark-300 rounded-md py-2 px-3 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" id="cancelReservation"
                            class="px-4 py-2 bg-gray-600 rounded hover:bg-gray-700">取消</button>
                        <button type="submit" id="saveReservation"
                            class="px-4 py-2 bg-blue-600 rounded hover:bg-blue-700">保存</button>
                        <button type="button" id="deleteReservation"
                            class="px-4 py-2 bg-red-600 rounded hover:bg-red-700 hidden">刪除</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Server管理 Modal -->
        <div id="serverModal"
            class="fixed inset-0 bg-black bg-opacity-50 hidden z-1 flex items-center justify-center transition-opacity duration-500 opacity-0 backdrop-blur">
            <div class="bg-dark-100 text-gray-200 m-3 p-6 rounded-lg shadow-lg max-w-md w-full transform scale-95 transition-all duration-300 opacity-0"
                id="serverBox">
                <h3 class="text-lg font-semibold mb-4">Server 管理</h3>
                <div class="mb-4">
                    <div class="flex">
                        <input type="text" id="serverName"
                            class="flex-1 bg-dark-200 border border-dark-300 rounded-l-md py-2 px-3 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="請輸入 Server 名稱">
                        <button id="addServer" class="bg-blue-600 hover:bg-blue-700 rounded-r-md px-4">
                            新增
                        </button>
                    </div>
                </div>
                <div class="max-h-80 overflow-y-auto">
                    <ul id="serverList" class="divide-y divide-dark-300"> </ul>
                </div>
                <div class="flex justify-end space-x-3 pt-4 border-t border-dark-300">
                    <button id="closeServerModal" class="px-4 py-2 bg-blue-600 rounded hover:bg-blue-700">完成</button>
                </div>
            </div>
        </div>

        <!-- 確認框 Modal -->
        <div id="confirmModal"
            class="fixed inset-0 bg-black bg-opacity-50 hidden z-100 flex items-center justify-center transition-opacity duration-500 opacity-0 backdrop-blur">
            <div class="bg-dark-100 text-gray-200 m-3 p-6 rounded-lg shadow-lg max-w-sm w-full transform scale-95 transition-all duration-300 opacity-0"
                id="confirmBox">
                <div id="confirmMessage" class="text-sm mb-6"></div>
                <div class="flex justify-end gap-3">
                    <button id="cancelBtn" class="px-4 py-2 bg-gray-600 rounded hover:bg-gray-700">取消</button>
                    <button id="confirmBtn" class="px-4 py-2 bg-blue-600 rounded hover:bg-blue-700">確認</button>
                </div>
            </div>
        </div>

        <!-- 提示框 Modal -->
        <div id="alertModal"
            class="fixed inset-0 bg-black bg-opacity-50 hidden z-100 flex items-center justify-center transition-all duration-500 opacity-0 backdrop-blur">
            <div class="bg-dark-100 text-gray-200 m-3 p-6 rounded-lg shadow-lg max-w-sm w-full transform scale-95 transition-all duration-300 opacity-0"
                id="alertBox">
                <div id="alertMessage" class="text-sm mb-6"></div>
                <div class="flex justify-end">
                    <button id="alertOkBtn" class="px-4 py-2 bg-blue-600 rounded hover:bg-blue-700">確認</button>
                </div>
            </div>
        </div>

        <!-- 預約詳情 Modal -->
        <div id="detailModal"
            class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center transition-opacity duration-500 opacity-0 backdrop-blur">
            <div class="bg-dark-100 text-gray-200 m-3 p-6 rounded-lg shadow-lg max-w-md w-full transform scale-95 transition-all duration-300 opacity-0"
                id="detailBox">
                <h3 class="text-lg font-semibold mb-4">預約詳情</h3>
                <dl class="divide-y divide-dark-300">
                    <div class="py-3 flex justify-between">
                        <dt class="text-gray-400">使用人</dt>
                        <dd id="detailUserName" class="font-medium text-gray-200">-</dd>
                    </div>
                    <div class="py-3 flex justify-between">
                        <dt class="text-gray-400">Server</dt>
                        <dd id="detailServer" class="font-medium text-gray-200">-</dd>
                    </div>
                    <div class="py-3 flex justify-between">
                        <dt class="text-gray-400">開始時間</dt>
                        <dd id="detailStart" class="font-medium text-gray-200">-</dd>
                    </div>
                    <div class="py-3 flex justify-between">
                        <dt class="text-gray-400">結束時間</dt>
                        <dd id="detailEnd" class="font-medium text-gray-200">-</dd>
                    </div>
                    <div class="py-3">
                        <dt class="text-gray-400 mb-1">備註</dt>
                        <dd id="detailNotes" class="font-medium text-gray-200 mt-1 text-sm">-</dd>
                    </div>
                    <div class="py-3 flex justify-between">
                        <dt class="text-gray-400">建立者</dt>
                        <dd id="detailCreator" class="font-medium text-gray-200">-</dd>
                    </div>
                </dl>
                <div class="flex justify-end space-x-3 pt-4 mt-2">
                    <button id="editReservation" class="px-4 py-2 bg-blue-600 rounded hover:bg-blue-700">編輯</button>
                    <button id="closeDetailModal" class="px-4 py-2 bg-gray-600 rounded hover:bg-gray-700">關閉</button>
                </div>
            </div>
        </div>

        <main class="mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="bg-dark-50 rounded-lg border border-dark-300 p-4 mb-6">
                <div class="flex flex-wrap justify-center gap-3 sm:justify-between">
                    <div class="flex space-x-2 items-center">
                        <button id="prevWeekBtn" class="text-blue-400 hover:text-blue-300 p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <h2 id="currentDateRange" class="text-lg font-medium text-gray-100"></h2>
                        <button id="nextWeekBtn" class="text-blue-400 hover:text-blue-300 p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>
                    <div class="flex space-x-2">
                        <button id="todayBtn"
                            class="bg-gray-600 hover:bg-gray-700 text-white text-sm px-3 py-1 rounded transition">
                            今天
                        </button>
                        <button id="manageServersBtn"
                            class="bg-gray-600 hover:bg-gray-700 text-white text-sm px-3 py-1 rounded transition">
                            管理 Server
                        </button>
                        <button id="newReservationBtn"
                            class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-1 rounded transition">
                            新增預約
                        </button>
                    </div>
                </div>
            </div>

            <div class="bg-dark-50 rounded-lg border border-dark-300 p-4 overflow-x-auto" style="min-height: 600px;">
                <div id="calendarContainer" class="min-w-max">
                </div>
            </div>
        </main>

        <footer class="p-6">
            <div class="text-center">
                <p class="text-gray-400">National Taiwan University</p>
                <p class="text-gray-400">Intelligent Sensing and Digital Manufacturing Lab</p>
                <p class="mt-4 text-gray-500">
                    <a href="mailto:shihwatson@gmail.com" class="hover:text-blue-400 transition-colors" target="_blank"
                        data-lang-key="copyRight">Contact: Watson</a>
                </p>
            </div>
        </footer>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, set, get, remove, child, update, push, onValue } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { initializeAppCheck, ReCaptchaV3Provider, getToken } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app-check.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD0d8TOznWih96YvABibKpLmCnbkIvzJZA",
            authDomain: "ntu-isdm-reservation01-92914.firebaseapp.com",
            databaseURL: "https://ntu-isdm-reservation01-92914-default-rtdb.firebaseio.com",
            projectId: "ntu-isdm-reservation01-92914",
            storageBucket: "ntu-isdm-reservation01-92914.firebasestorage.app",
            messagingSenderId: "336071577111",
            appId: "1:336071577111:web:a47cca77155e18ac5f9652",
            measurementId: "G-8JRMJR7CYZ"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        window.firebase = {
            db,
            auth,
            provider,
            ref,
            set,
            get,
            remove,
            child,
            update,
            push,
            onValue,
            signInWithPopup,
            signOut,
            onAuthStateChanged,
            GoogleAuthProvider
        };

        document.dispatchEvent(new Event('firebaseReady'));
    </script>

    <script>
        let currentWeekStart = new Date();
        currentWeekStart.setHours(0, 0, 0, 0);
        currentWeekStart.setDate(currentWeekStart.getDate() - (currentWeekStart.getDay() || 7) + 1);

        let servers = [];
        let reservations = [];
        let editingReservationId = null;
        let viewingReservationId = null;
        let currentUser = null;

        const loadingOverlay = document.getElementById('loadingOverlay');
        const loginContainer = document.getElementById('loginContainer');
        const mainContent = document.getElementById('mainContent');

        function showLoadingOverlay() {
            loadingOverlay.classList.remove('hidden');
        }

        function hideLoadingOverlay() {
            loadingOverlay.classList.add('hidden');
        }

        function showConfirmModal(message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmModal');
                const box = document.getElementById('confirmBox');
                const msg = document.getElementById('confirmMessage');
                const confirmBtn = document.getElementById('confirmBtn');
                const cancelBtn = document.getElementById('cancelBtn');

                msg.textContent = message;
                modal.classList.remove('hidden');

                requestAnimationFrame(() => {
                    modal.classList.add('opacity-100');
                    box.classList.add('opacity-100', 'scale-100');
                    box.classList.remove('scale-95');
                });

                const cleanup = () => {
                    modal.classList.remove('opacity-100');
                    box.classList.remove('opacity-100', 'scale-100');
                    box.classList.add('scale-95');

                    setTimeout(() => {
                        modal.classList.add('hidden');
                    }, 300);

                    confirmBtn.removeEventListener('click', onConfirm);
                    cancelBtn.removeEventListener('click', onCancel);
                };

                const onConfirm = () => {
                    cleanup();
                    resolve(true);
                };

                const onCancel = () => {
                    cleanup();
                    resolve(false);
                };

                confirmBtn.addEventListener('click', onConfirm);
                cancelBtn.addEventListener('click', onCancel);
            });
        }

        function showAlertModal(message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('alertModal');
                const box = document.getElementById('alertBox');
                const msg = document.getElementById('alertMessage');
                const okBtn = document.getElementById('alertOkBtn');

                msg.textContent = message;
                modal.classList.remove('hidden');

                requestAnimationFrame(() => {
                    modal.classList.add('opacity-100');
                    box.classList.add('opacity-100', 'scale-100');
                    box.classList.remove('scale-95');
                });

                const cleanup = () => {
                    modal.classList.remove('opacity-100');
                    box.classList.remove('opacity-100', 'scale-100');
                    box.classList.add('scale-95');

                    setTimeout(() => {
                        modal.classList.add('hidden');
                    }, 300);

                    okBtn.removeEventListener('click', onOk);
                };

                const onOk = () => {
                    cleanup();
                    resolve(true);
                };

                okBtn.addEventListener('click', onOk);
            });
        }

        const reservationModal = document.getElementById('reservationModal');
        const reservationBox = document.getElementById('reservationBox');
        const reservationForm = document.getElementById('reservationForm');
        const cancelReservationBtn = document.getElementById('cancelReservation');
        const deleteReservationBtn = document.getElementById('deleteReservation');
        const reservationTitle = document.getElementById('reservationTitle');

        function showReservationModal(mode = 'new', reservationId = null) {
            editingReservationId = reservationId;

            reservationTitle.textContent = mode === 'new' ? '新增預約' : '編輯預約';

            deleteReservationBtn.classList.toggle('hidden', mode === 'new');

            if (mode === 'edit' && reservationId) {
                const reservation = reservations.find(r => r.id === reservationId);
                if (reservation) {
                    document.getElementById('userName').value = reservation.userName;
                    document.getElementById('serverSelect').value = reservation.serverId;
                    document.getElementById('reservationCreator').value = reservation.creatorId || '';

                    const startDate = new Date(reservation.startTime);
                    document.getElementById('reservationDate').value = formatDateForInput(startDate);
                    document.getElementById('startTime').value = formatTimeForSelect(startDate);

                    const endDate = new Date(reservation.endTime);
                    document.getElementById('endTime').value = formatTimeForSelect(endDate);

                    document.getElementById('notes').value = reservation.notes || '';

                    const canDelete = reservation.creatorId === currentUser.uid;
                    deleteReservationBtn.classList.toggle('hidden', !canDelete);
                }
            } else {
                reservationForm.reset();

                document.getElementById('reservationCreator').value = currentUser.uid;

                const today = new Date();
                document.getElementById('reservationDate').value = formatDateForInput(today);

                const nextHour = new Date();
                nextHour.setHours(nextHour.getHours() + 1, 0, 0, 0);
                const nextTwoHours = new Date(nextHour);
                nextTwoHours.setHours(nextTwoHours.getHours() + 1);

                document.getElementById('startTime').value = formatTimeForSelect(nextHour);
                document.getElementById('endTime').value = formatTimeForSelect(nextTwoHours);
            }

            reservationModal.classList.remove('hidden');

            requestAnimationFrame(() => {
                reservationModal.classList.add('opacity-100');
                reservationBox.classList.add('opacity-100', 'scale-100');
                reservationBox.classList.remove('scale-95');
            });
        }

        function hideReservationModal() {
            reservationModal.classList.remove('opacity-100');
            reservationBox.classList.remove('opacity-100', 'scale-100');
            reservationBox.classList.add('scale-95');

            setTimeout(() => {
                reservationModal.classList.add('hidden');
                editingReservationId = null;
            }, 300);
        }

        const detailModal = document.getElementById('detailModal');
        const detailBox = document.getElementById('detailBox');
        const closeDetailBtn = document.getElementById('closeDetailModal');
        const editReservationBtn = document.getElementById('editReservation');

        function showDetailModal(reservationId) {
            const reservation = reservations.find(r => r.id === reservationId);
            if (!reservation) return;

            viewingReservationId = reservationId;

            document.getElementById('detailUserName').textContent = reservation.userName;

            const server = servers.find(s => s.id === reservation.serverId);
            document.getElementById('detailServer').textContent = server ? server.name : '';

            const startDate = new Date(reservation.startTime);
            const endDate = new Date(reservation.endTime);

            document.getElementById('detailStart').textContent = formatDateTime(startDate);
            document.getElementById('detailEnd').textContent = formatDateTime(endDate);
            document.getElementById('detailNotes').textContent = reservation.notes || '';

            if (reservation.creatorName) {
                document.getElementById('detailCreator').textContent = reservation.creatorName;
            } else {
                document.getElementById('detailCreator').textContent = '未知';
            }

            const canEdit = reservation.creatorId === currentUser.uid;
            editReservationBtn.style.display = canEdit ? 'block' : 'none';

            detailModal.classList.remove('hidden');

            requestAnimationFrame(() => {
                detailModal.classList.add('opacity-100');
                detailBox.classList.add('opacity-100', 'scale-100');
                detailBox.classList.remove('scale-95');
            });
        }

        function hideDetailModal() {
            detailModal.classList.remove('opacity-100');
            detailBox.classList.remove('opacity-100', 'scale-100');
            detailBox.classList.add('scale-95');

            setTimeout(() => {
                detailModal.classList.add('hidden');
                viewingReservationId = null;
            }, 300);
        }

        const serverModal = document.getElementById('serverModal');
        const serverBox = document.getElementById('serverBox');
        const closeServerBtn = document.getElementById('closeServerModal');
        const addServerBtn = document.getElementById('addServer');
        const serverNameInput = document.getElementById('serverName');
        const serverList = document.getElementById('serverList');

        function showServerModal() {
            renderServerList();

            serverModal.classList.remove('hidden');

            requestAnimationFrame(() => {
                serverModal.classList.add('opacity-100');
                serverBox.classList.add('opacity-100', 'scale-100');
                serverBox.classList.remove('scale-95');
            });
        }

        function hideServerModal() {
            serverModal.classList.remove('opacity-100');
            serverBox.classList.remove('opacity-100', 'scale-100');
            serverBox.classList.add('scale-95');

            setTimeout(() => {
                serverModal.classList.add('hidden');
                serverNameInput.value = '';
            }, 300);
        }

        function renderServerList() {
            serverList.innerHTML = '';

            if (servers.length === 0) {
                serverList.innerHTML = `<li class="py-3 text-gray-400 text-center">尚無Server</li>`;
                return;
            }

            servers.forEach(server => {
                const li = document.createElement('li');
                li.className = 'py-3 flex justify-between items-center';
                li.innerHTML = `
                    <span class="text-gray-200">${server.name}</span>
                    <button class="text-red-400 hover:text-red-300" data-server-id="${server.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                `;

                li.querySelector('button').addEventListener('click', () => deleteServer(server.id));

                serverList.appendChild(li);
            });
        }

        function formatDate(date) {
            return `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;
        }

        function formatDateForInput(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        function formatTimeForSelect(date) {
            return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        }

        function formatDateTime(date) {
            return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        }

        function populateTimeSelects() {
            const startTimeSelect = document.getElementById('startTime');
            const endTimeSelect = document.getElementById('endTime');

            startTimeSelect.innerHTML = '';
            endTimeSelect.innerHTML = '';

            for (let hour = 0; hour < 24; hour++) {
                for (let minute = 0; minute < 60; minute += 30) {
                    const time = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;

                    const startOption = document.createElement('option');
                    startOption.value = time;
                    startOption.textContent = time;
                    startTimeSelect.appendChild(startOption);

                    const endOption = document.createElement('option');
                    endOption.value = time;
                    endOption.textContent = time;
                    endTimeSelect.appendChild(endOption);
                }
            }
        }

        function updateServerSelect() {
            const serverSelect = document.getElementById('serverSelect');
            serverSelect.innerHTML = '';

            servers.forEach(server => {
                const option = document.createElement('option');
                option.value = server.id;
                option.textContent = server.name;
                serverSelect.appendChild(option);
            });
        }

        function renderCalendar() {
            const calendarContainer = document.getElementById('calendarContainer');
            calendarContainer.innerHTML = '';

            if (servers.length === 0) {
                calendarContainer.innerHTML = `
                    <div class="py-8 text-center text-gray-400">
                        無任何 Server，請先點擊「管理 Server」按鈕新增。
                    </div>
                `;
                return;
            }

            const weekDates = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(currentWeekStart);
                date.setDate(date.getDate() + i);
                weekDates.push(date);
            }

            updateDateRangeDisplay(weekDates);

            const table = document.createElement('table');
            table.className = 'w-full border-collapse border-dark-300';

            const thead = document.createElement('thead');
            let headerRow = document.createElement('tr');
            headerRow.className = 'bg-dark-200';

            let timeHeader = document.createElement('th');
            timeHeader.className = 'calendar-header border border-dark-300 p-2 text-left';
            timeHeader.textContent = '';
            headerRow.appendChild(timeHeader);

            const dayNames = ['星期一', '星期二', '星期三', '星期四', '星期五', '星期六', '星期日'];
            weekDates.forEach((date, index) => {
                const th = document.createElement('th');
                th.className = 'border border-dark-300 p-2 text-center';

                const isToday = isSameDay(date, new Date());

                const dayLabel = document.createElement('div');
                dayLabel.className = 'text-sm mb-1 ' + (isToday ? 'text-blue-400' : 'text-gray-400');
                dayLabel.textContent = dayNames[index];

                const dateLabel = document.createElement('div');
                dateLabel.className = isToday ? 'text-blue-400 font-semibold' : 'text-gray-200';
                dateLabel.textContent = `${date.getMonth() + 1}/${date.getDate()}`;

                th.appendChild(dayLabel);
                th.appendChild(dateLabel);
                headerRow.appendChild(th);
            });

            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');

            servers.forEach(server => {
                const serverRow = document.createElement('tr');
                serverRow.className = 'border-t border-dark-300';

                const serverNameCell = document.createElement('td');
                serverNameCell.className = 'calendar-header border border-dark-300 p-2 font-medium text-gray-200';
                serverNameCell.textContent = server.name;
                serverRow.appendChild(serverNameCell);

                weekDates.forEach(date => {
                    const cell = document.createElement('td');
                    cell.className = 'calendar-cell border border-dark-300 p-1 align-top';

                    const dayReservations = getReservationsForDay(server.id, date);

                    dayReservations.forEach(reservation => {
                        const badge = document.createElement('div');
                        badge.className = 'reservation-badge';
                        badge.textContent = `${getTimeText(new Date(reservation.startTime))} - ${getTimeText(new Date(reservation.endTime))} ${reservation.userName}`;
                        badge.setAttribute('data-reservation-id', reservation.id);

                        badge.addEventListener('click', () => {
                            showDetailModal(reservation.id);
                        });

                        cell.appendChild(badge);
                    });

                    cell.addEventListener('click', (e) => {
                        if (e.target.classList.contains('reservation-badge')) return;

                        resetReservationForm();

                        showReservationModal('new');

                        document.getElementById('serverSelect').value = server.id;

                        const formattedDate = formatDateForInput(new Date(date));
                        document.getElementById('reservationDate').value = formattedDate;

                    });

                    serverRow.appendChild(cell);
                });

                tbody.appendChild(serverRow);
            });

            table.appendChild(tbody);
            calendarContainer.appendChild(table);
        }

        function getTimeText(date) {
            return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        }

        function getReservationsForDay(serverId, date) {
            return reservations.filter(reservation => {
                const startTime = new Date(reservation.startTime);
                const endTime = new Date(reservation.endTime);

                return reservation.serverId === serverId &&
                    (isSameDay(startTime, date) || isSameDay(endTime, date) ||
                        (startTime < date && endTime > date));
            });
        }

        function isSameDay(date1, date2) {
            return date1.getFullYear() === date2.getFullYear() &&
                date1.getMonth() === date2.getMonth() &&
                date1.getDate() === date2.getDate();
        }

        function updateDateRangeDisplay(weekDates) {
            const startDate = weekDates[0];
            const endDate = weekDates[6];

            let dateRangeText;
            if (startDate.getMonth() === endDate.getMonth()) {
                dateRangeText = `${startDate.getFullYear()}年${startDate.getMonth() + 1}月${startDate.getDate()}日 - ${endDate.getDate()}日`;
            } else {
                dateRangeText = `${startDate.getFullYear()}年${startDate.getMonth() + 1}月${startDate.getDate()}日 - ${endDate.getMonth() + 1}月${endDate.getDate()}日`;
            }

            document.getElementById('currentDateRange').textContent = dateRangeText;
        }

        function resetReservationForm() {
            reservationForm.reset();
            document.getElementById('reservationId').value = '';
            document.getElementById('reservationCreator').value = currentUser.uid;

            const today = new Date();
            document.getElementById('reservationDate').value = formatDateForInput(today);

            const nextHour = new Date();
            nextHour.setHours(nextHour.getHours() + 1, 0, 0, 0);
            const nextTwoHours = new Date(nextHour);
            nextTwoHours.setHours(nextTwoHours.getHours() + 1);

            document.getElementById('startTime').value = formatTimeForSelect(nextHour);
            document.getElementById('endTime').value = formatTimeForSelect(nextTwoHours);
        }

        function loadServers() {
            const serversRef = window.firebase.ref(window.firebase.db, 'servers');

            return window.firebase.get(serversRef)
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        servers = Object.keys(data).map(key => ({
                            id: key,
                            name: data[key].name
                        }));
                    } else {
                        servers = [];
                    }
                    updateServerSelect();
                })
                .catch((error) => {
                    console.error("讀取資料錯誤:", error);
                });
        }

        function loadReservations() {
            const reservationsRef = window.firebase.ref(window.firebase.db, 'reservations');

            return window.firebase.get(reservationsRef)
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        reservations = Object.keys(data).map(key => ({
                            id: key,
                            ...data[key]
                        }));
                    } else {
                        reservations = [];
                    }
                })
                .catch((error) => {
                    console.error("讀取預約資料錯誤:", error);
                });
        }

        function addServer(name) {
            if (servers.some(server => server.name === name)) {
                showAlertModal('Server 名稱已存在');
                return Promise.reject(new Error('Server name already exists'));
            }

            const serversRef = window.firebase.ref(window.firebase.db, 'servers');
            const newServerRef = window.firebase.push(serversRef);

            return window.firebase.set(newServerRef, {
                name: name,
                createdBy: currentUser.uid,
                createdAt: new Date().toISOString()
            }).then(() => {
                servers.push({
                    id: newServerRef.key,
                    name: name
                });
                updateServerSelect();
                renderServerList();
                renderCalendar();
                showAlertModal('Server 新增成功');
            }).catch(error => {
                console.error("新增 Server 錯誤:", error);
            });
        }

        async function deleteServer(serverId) {
            const confirmed = await showConfirmModal('確定要刪除此 Server 嗎？相關的預約也將被刪除。');
            if (!confirmed) return;

            const serverRef = window.firebase.ref(window.firebase.db, `servers/${serverId}`);

            const relatedReservations = reservations.filter(r => r.serverId === serverId);

            const deletePromises = [window.firebase.remove(serverRef)];

            relatedReservations.forEach(reservation => {
                const reservationRef = window.firebase.ref(window.firebase.db, `reservations/${reservation.id}`);
                deletePromises.push(window.firebase.remove(reservationRef));
            });

            Promise.all(deletePromises)
                .then(() => {
                    servers = servers.filter(server => server.id !== serverId);
                    reservations = reservations.filter(r => r.serverId !== serverId);
                    updateServerSelect();
                    renderServerList();
                    renderCalendar();
                    showAlertModal('Server 刪除成功');
                })
                .catch(error => {
                    console.error("刪除 Server 錯誤:", error);
                });
        }

        function saveReservation(reservationData) {
            let reservationRef;

            if (editingReservationId) {
                const existingReservation = reservations.find(r => r.id === editingReservationId);
                if (existingReservation && existingReservation.creatorId !== currentUser.uid) {
                    showAlertModal('您沒有權限編輯此預約');
                    return Promise.reject(new Error('No permission to edit'));
                }

                reservationRef = window.firebase.ref(window.firebase.db, `reservations/${editingReservationId}`);

                return window.firebase.update(reservationRef, reservationData)
                    .then(() => {
                        const index = reservations.findIndex(r => r.id === editingReservationId);
                        if (index !== -1) {
                            reservations[index] = {
                                ...reservations[index],
                                ...reservationData
                            };
                        }

                        renderCalendar();
                        hideReservationModal();
                        showAlertModal('預約更新成功');
                    })
                    .catch(error => {
                        console.error("更新預約錯誤:", error);
                    });
            } else {
                const reservationsRef = window.firebase.ref(window.firebase.db, 'reservations');
                reservationRef = window.firebase.push(reservationsRef);

                return window.firebase.set(reservationRef, reservationData)
                    .then(() => {
                        reservations.push({
                            id: reservationRef.key,
                            ...reservationData
                        });

                        renderCalendar();
                        hideReservationModal();
                        showAlertModal('預約新增成功');
                    })
                    .catch(error => {
                        console.error("新增預約錯誤:", error);
                    });
            }
        }

        async function deleteReservation(reservationId) {
            const reservation = reservations.find(r => r.id === reservationId);

            if (reservation && reservation.creatorId !== currentUser.uid) {
                showAlertModal('您沒有權限刪除此預約');
                return;
            }

            const confirmed = await showConfirmModal('確定要刪除此預約嗎？');
            if (!confirmed) return;

            const reservationRef = window.firebase.ref(window.firebase.db, `reservations/${reservationId}`);

            window.firebase.remove(reservationRef)
                .then(() => {
                    reservations = reservations.filter(r => r.id !== reservationId);

                    hideReservationModal();
                    hideDetailModal();
                    renderCalendar();
                    showAlertModal('預約刪除成功');
                })
                .catch(error => {
                    console.error("刪除預約錯誤:", error);
                });
        }

        function isOverlapping(serverId, startTime, endTime, excludeReservationId = null) {
            return reservations.some(reservation => {
                if (excludeReservationId && reservation.id === excludeReservationId) {
                    return false;
                }

                if (reservation.serverId !== serverId) {
                    return false;
                }

                const reservationStart = new Date(reservation.startTime).getTime();
                const reservationEnd = new Date(reservation.endTime).getTime();

                return (startTime < reservationEnd && endTime > reservationStart);
            });
        }

        function setupAuthListeners() {
            const googleLoginBtn = document.getElementById('googleLoginBtn');
            googleLoginBtn.addEventListener('click', () => {
                showLoadingOverlay();
                window.firebase.signInWithPopup(window.firebase.auth, window.firebase.provider)
                    .then((result) => {
                        const user = result.user;
                        const userEmailKey = user.email.replace(/\./g, ',');
                        const allowedUsersRef = window.firebase.ref(window.firebase.db, `allowedUsers/${userEmailKey}`);

                        return window.firebase.get(allowedUsersRef).then(snapshot => {
                            if (!snapshot.exists()) {
                                return window.firebase.signOut(window.firebase.auth).then(() => {
                                    throw new Error('未授權帳號');
                                });
                            }
                            return user;
                        });
                    })
                    .catch(error => {
                        console.error('登入錯誤:', error);
                        hideLoadingOverlay();
                        showAlertModal('存取資料庫失敗，可能是您的帳戶未經授權，請聯繫管理員。');
                    });
            });

            const logoutBtn = document.getElementById('logoutBtn');
            logoutBtn.addEventListener('click', () => {
                window.firebase.signOut(window.firebase.auth)
                    .then(() => {
                    })
                    .catch(error => {
                        console.error('登出錯誤:', error);
                    });
            });

            window.firebase.onAuthStateChanged(window.firebase.auth, (user) => {
                hideLoadingOverlay();

                if (user) {
                    currentUser = user;
                    showUserInterface();
                } else {
                    currentUser = null;
                    showLoginInterface();
                }
            });
        }

        function showUserInterface() {
            const userProfile = document.getElementById('userProfile');
            userProfile.innerHTML = `
                <img src="${currentUser.photoURL}" alt="${currentUser.displayName}" title="${currentUser.email}">
                <span class="hidden sm:inline-block text-sm">${currentUser.displayName}</span>
            `;

            loginContainer.style.display = 'none';
            mainContent.style.display = 'block';

            showLoadingOverlay();
            Promise.all([loadServers(), loadReservations()])
                .then(() => {
                    renderCalendar();
                    hideLoadingOverlay();
                })
                .catch(error => {
                    console.error("初始化錯誤:", error);
                    hideLoadingOverlay();
                });
        }

        function showLoginInterface() {
            loginContainer.style.display = 'flex';
            mainContent.style.display = 'none';
        }

        document.addEventListener('firebaseReady', () => {
            setupAuthListeners();
            populateTimeSelects();

            document.getElementById('prevWeekBtn').addEventListener('click', () => {
                currentWeekStart.setDate(currentWeekStart.getDate() - 7);
                renderCalendar();
            });

            document.getElementById('nextWeekBtn').addEventListener('click', () => {
                currentWeekStart.setDate(currentWeekStart.getDate() + 7);
                renderCalendar();
            });

            document.getElementById('todayBtn').addEventListener('click', () => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                currentWeekStart = new Date(today);
                currentWeekStart.setDate(currentWeekStart.getDate() - (currentWeekStart.getDay() || 7) + 1);
                renderCalendar();
            });

            document.getElementById('manageServersBtn').addEventListener('click', () => {
                showServerModal();
            });

            document.getElementById('newReservationBtn').addEventListener('click', () => {
                resetReservationForm();
                showReservationModal('new');
            });

            closeServerBtn.addEventListener('click', () => {
                hideServerModal();
            });

            addServerBtn.addEventListener('click', () => {
                const serverName = serverNameInput.value.trim();
                if (!serverName) {
                    showAlertModal('請輸入Server名稱');
                    return;
                }

                addServer(serverName).then(() => {
                    serverNameInput.value = '';
                });
            });

            serverNameInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    addServerBtn.click();
                }
            });

            cancelReservationBtn.addEventListener('click', () => {
                hideReservationModal();
            });

            deleteReservationBtn.addEventListener('click', () => {
                if (editingReservationId) {
                    deleteReservation(editingReservationId);
                }
            });

            reservationForm.addEventListener('submit', (e) => {
                e.preventDefault();

                const userName = document.getElementById('userName').value.trim();
                const serverId = document.getElementById('serverSelect').value;
                const reservationDate = document.getElementById('reservationDate').value;
                const startTime = document.getElementById('startTime').value;
                const endTime = document.getElementById('endTime').value;
                const notes = document.getElementById('notes').value.trim();
                const creatorId = document.getElementById('reservationCreator').value;

                const startDateTime = new Date(`${reservationDate}T${startTime}`);
                const endDateTime = new Date(`${reservationDate}T${endTime}`);

                if (endDateTime <= startDateTime) {
                    showAlertModal('結束時間必須晚於開始時間');
                    return;
                }

                if (isOverlapping(serverId, startDateTime.getTime(), endDateTime.getTime(), editingReservationId)) {
                    showAlertModal('該時段已有預約，請選擇其他時段');
                    return;
                }

                const reservationData = {
                    userName,
                    serverId,
                    startTime: startDateTime.toISOString(),
                    endTime: endDateTime.toISOString(),
                    notes,
                    creatorId: creatorId || currentUser.uid,
                    creatorName: currentUser.displayName,
                    creatorEmail: currentUser.email,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                saveReservation(reservationData);
            });

            closeDetailBtn.addEventListener('click', () => {
                hideDetailModal();
            });

            editReservationBtn.addEventListener('click', () => {
                if (viewingReservationId) {
                    hideDetailModal();
                    showReservationModal('edit', viewingReservationId);
                }
            });

            function setupRealtimeListeners() {
                if (!currentUser) return;

                const serversRef = window.firebase.ref(window.firebase.db, 'servers');
                window.firebase.onValue(serversRef, (snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        servers = Object.keys(data).map(key => ({
                            id: key,
                            name: data[key].name
                        }));
                    } else {
                        servers = [];
                    }
                    updateServerSelect();
                    renderCalendar();
                });

                const reservationsRef = window.firebase.ref(window.firebase.db, 'reservations');
                window.firebase.onValue(reservationsRef, (snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        reservations = Object.keys(data).map(key => ({
                            id: key,
                            ...data[key]
                        }));
                    } else {
                        reservations = [];
                    }
                    renderCalendar();
                });
            }
        });
    </script>
</body>

</html>