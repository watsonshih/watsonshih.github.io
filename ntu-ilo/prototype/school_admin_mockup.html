<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://watsonshih.github.io/pic/watson-logo.png">
    <link rel="shortcut icon" href="https://watsonshih.github.io/pic/watson-logo.png" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>學校行政 - ILO 學生就學狀態追蹤系統 (模擬)</title>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-VJZ2K72PMZ"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-VJZ2K72PMZ');
    </script>
    <style>
        :root {
            --primary-color: #4CAF50;
            --primary-dark: #45a049;
            --light-gray: #f4f4f4;
            --medium-gray: #ddd;
            --dark-gray: #333;
            --white: #fff;
            --blue: #007bff;
            --blue-dark: #0056b3;
            --red: #dc3545;
            --orange: orange;
            --yellow: #ffc107;
            --yellow-dark: #e0a800;
            --info-bg: #d1ecf1;
            --info-border: #bee5eb;
            --info-text: #0c5460;
            --warning-bg: #fff3cd;
            --warning-border: #ffeeba;
            --warning-text: #856404;
            --danger-bg: #f8d7da;
            --danger-border: #f5c6cb;
            --danger-text: #721c24;
            --success-bg: #d4edda;
            --success-border: #c3e6cb;
            --success-text: #155724;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            display: flex;
            min-height: 100vh;
            background-color: var(--light-gray);
            color: var(--dark-gray);
        }

        nav {
            background-color: var(--primary-color);
            color: var(--white);
            width: 240px;
            padding: 20px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }

        nav h2 {
            margin-top: 0;
            font-size: 1.3em;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 10px;
        }

        nav ul {
            list-style: none;
            padding: 0;
            margin: 20px 0;
        }

        nav li {
            margin: 0;
        }

        nav a {
            color: var(--white);
            text-decoration: none;
            display: block;
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 5px;
            transition: background-color 0.2s ease;
        }

        nav a:hover,
        nav a.active {
            background-color: var(--primary-dark);
            color: var(--white);
        }

        .nav-footer {
            margin-top: auto;
            font-size: 0.8em;
            opacity: 0.8;
            padding: 10px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        main {
            flex-grow: 1;
            padding: 25px;
        }

        h1,
        h2 {
            color: var(--dark-gray);
            border-bottom: 1px solid var(--medium-gray);
            padding-bottom: 8px;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 1.8em;
        }

        h2 {
            font-size: 1.4em;
        }

        h3 {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: var(--dark-gray);
        }

        h4 {
            font-size: 1.1em;
            margin-bottom: 10px;
            color: var(--dark-gray);
        }


        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background-color: var(--white);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        th,
        td {
            border: 1px solid var(--medium-gray);
            padding: 10px 12px;
            text-align: left;
            font-size: 0.9em;
            vertical-align: middle;
        }

        th {
            background-color: #e9ecef;
            font-weight: 600;
        }

        tbody tr:nth-child(odd) {
            background-color: #f8f9fa;
        }

        tbody tr:hover {
            background-color: #e9ecef;
        }

        button,
        select,
        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="file"],
        textarea {
            padding: 8px 12px;
            margin: 2px;
            font-size: 0.9em;
            border: 1px solid var(--medium-gray);
            border-radius: 4px;
            box-sizing: border-box;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: var(--blue);
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
            outline: none;
        }

        button {
            background-color: var(--blue);
            color: var(--white);
            cursor: pointer;
            border: none;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }

        button:hover {
            background-color: var(--blue-dark);
        }

        button:disabled {
            background-color: #adb5bd;
            cursor: not-allowed;
            opacity: 0.7;
        }

        button.secondary {
            background-color: #6c757d;
        }

        button.secondary:hover {
            background-color: #5a6268;
        }

        button.warning {
            background-color: var(--yellow);
            color: var(--dark-gray);
        }

        button.warning:hover {
            background-color: var(--yellow-dark);
        }


        .action-buttons button {
            margin-right: 8px;
            margin-top: 5px;
        }

        .filter-section,
        .form-section,
        .info-box,
        .program-card {
            background-color: var(--white);
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .form-grid label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .form-grid .full-width {
            grid-column: 1 / -1;
        }

        .readonly,
        input:read-only,
        select:disabled,
        textarea:read-only {
            background-color: #e9ecef;
            cursor: not-allowed;
            opacity: 0.8;
        }

        .error-message {
            color: var(--red);
            font-size: 0.85em;
            margin-top: 4px;
            display: block;
        }

        input.error,
        select.error,
        textarea.error {
            border-color: var(--red);
        }

        .status-待提交 {
            color: var(--orange);
            font-weight: bold;
        }

        .status-待審核 {
            color: var(--blue);
            font-weight: bold;
        }

        .status-已退回 {
            color: var(--red);
            font-weight: bold;
        }

        .status-已通過 {
            color: var(--primary-color);
            font-weight: bold;
        }

        .status-不適用 {
            color: #6c757d;
            font-style: italic;
        }

        .highlight {
            background-color: var(--warning-bg);
            border-left: 3px solid var(--warning-text);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: var(--white);
            margin: 5% auto;
            padding: 25px 30px;
            border: none;
            width: 90%;
            max-width: 950px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .modal-close {
            color: #aaa;
            float: right;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            padding: 0 5px;
        }

        .modal-close:hover {
            color: var(--dark-gray);
        }

        .modal-header {
            border-bottom: 1px solid var(--medium-gray);
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            margin: 0;
            padding: 0;
            border: none;
        }

        .modal-footer {
            border-top: 1px solid var(--medium-gray);
            padding-top: 15px;
            margin-top: 25px;
            text-align: right;
        }

        .modal-footer button {
            margin-left: 10px;
        }


        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }


        .required::after {
            content: "*";
            color: var(--red);
            margin-left: 3px;
        }

        textarea {
            width: 100%;
            min-height: 70px;
            resize: vertical;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid transparent;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert::before {
            content: '';
            font-weight: bold;
            display: inline-block;
            width: 1.2em;
            height: 1.2em;
            line-height: 1.2em;
            text-align: center;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .alert-info {
            background-color: var(--info-bg);
            border-color: var(--info-border);
            color: var(--info-text);
        }

        .alert-info::before {
            content: 'ℹ';
            background-color: var(--info-text);
            color: var(--white);
        }

        .alert-warning {
            background-color: var(--warning-bg);
            border-color: var(--warning-border);
            color: var(--warning-text);
        }

        .alert-warning::before {
            content: '!';
            background-color: var(--warning-text);
            color: var(--white);
        }

        .alert-danger {
            background-color: var(--danger-bg);
            border-color: var(--danger-border);
            color: var(--danger-text);
        }

        .alert-danger::before {
            content: '✖';
            background-color: var(--danger-text);
            color: var(--white);
        }

        .alert-success {
            background-color: var(--success-bg);
            border-color: var(--success-border);
            color: var(--success-text);
        }

        .alert-success::before {
            content: '✔';
            background-color: var(--success-text);
            color: var(--white);
        }


        .access-notice {
            text-align: center;
            font-weight: bold;
        }

        .subsidy-input {
            width: 90px;
            text-align: right;
        }

        .table-container {
            max-height: 65vh;
            overflow-y: auto;
            border: 1px solid var(--medium-gray);
            border-radius: 4px;
        }

        .upload-placeholder {
            font-style: italic;
            color: #888;
        }

        .sticky-actions {
            position: sticky;
            bottom: 0;
            background-color: rgba(244, 244, 244, 0.95);
            padding: 15px 20px;
            border-top: 1px solid var(--medium-gray);
            margin: 20px -20px -20px -20px;
            text-align: right;
            z-index: 10;
        }

        .sticky-actions button {
            margin-left: 10px;
        }

        #program-list-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .program-card {
            padding: 15px;
            border-left: 5px solid var(--primary-color);
        }

        .program-card h3 {
            margin-top: 0;
            margin-bottom: 10px;
            border: none;
        }

        .program-card p {
            font-size: 0.9em;
            color: #555;
            margin-bottom: 15px;
        }

        .program-card .action-buttons button {
            font-size: 0.85em;
            padding: 6px 10px;
        }

        #student-list-view {
            display: none;
        }

        .back-button {
            margin-bottom: 15px;
        }
    </style>
</head>

<body>
    <nav>
        <h2>學校行政選單</h2>
        <p style="padding: 0 5px; font-size: 0.9em; opacity: 0.9;">學校: <span id="school-admin-name">國立台灣大學 (模擬)</span>
        </p>
        <ul>
            <li><a href="#dashboard" class="nav-link active" onclick="showSection('dashboard')">儀表板</a></li>
            <li><a href="#students" class="nav-link" onclick="showSection('students')">學生資料管理</a></li>
            <li><a href="#registration" class="nav-link" onclick="showSection('registration')">註冊與補助登錄</a></li>
            <li><a href="#not-registered" class="nav-link" onclick="showSection('not-registered')">不註冊學生登錄</a></li>
        </ul>
        <div class="nav-footer">
            <p>Demo 版本，不可用於實際使用途</p>
            <p>V20250415</p>
        </div>
    </nav>
    <main id="main-content">
        <div id="access-time-notice" class="access-notice alert" style="display: none;">
        </div>

        <section id="dashboard" class="section active">
            <h1>儀表板</h1>
            <p>歡迎，<strong><span id="school-admin-welcome-name">成功大學</span></strong> 行政人員！</p>
            <div class="info-box">
                <h2><i class="fas fa-tasks"></i> 待辦事項</h2>
                <ul id="todo-list">
                </ul>
            </div>
            <div class="info-box">
                <h2><i class="fas fa-university"></i> 負責專班概況</h2>
                <ul id="program-summary">
                </ul>
            </div>
        </section>

        <section id="students" class="section">
            <h1>學生資料管理</h1>

            <div id="program-list-container">
                <h2>請選擇專班</h2>
                <p id="no-managed-programs" style="display: none;">您目前沒有負責管理的專班。</p>
            </div>

            <div id="student-list-view" style="display: none;">
                <button class="back-button secondary" onclick="showProgramList()"><i class="fas fa-arrow-left"></i>
                    返回專班列表</button>
                <h2 id="student-list-header">學生列表</h2>
                <div class="action-buttons" style="margin-bottom: 15px;">
                    <button id="add-student-for-program-btn" onclick="openAddStudentModalForSelectedProgram()">
                        <i class="fas fa-plus"></i> 新增此專班學生
                    </button>
                </div>
                <div class="table-container">
                    <table id="student-list-table">
                        <thead>
                            <tr>
                                <th>護照號碼</th>
                                <th>英文姓名</th>
                                <th>國籍</th>
                                <th>當學期入學情況</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>


        <section id="registration" class="section">
            <h1>註冊與補助登錄</h1>
            <div class="filter-section">
                <label for="reg-program-select">選擇專班 (學期):</label>
                <select id="reg-program-select" onchange="renderRegistrationForm()">
                    <option value="">請選擇</option>
                </select>
            </div>
            <div id="registration-content">
            </div>
        </section>

        <section id="not-registered" class="section">
            <h1>不註冊學生登錄</h1>
            <div class="filter-section">
                <label for="nr-program-select">選擇專班 (學期):</label>
                <select id="nr-program-select" onchange="renderNotRegisteredForm()">
                    <option value="">請選擇</option>
                </select>
            </div>
            <div id="not-registered-content">
            </div>
        </section>

        <div id="student-details-modal" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeModal('student-details-modal')">&times;</span>
                <div class="modal-header">
                    <h2>學生詳細資料 (唯讀)</h2>
                </div>
                <form id="student-details-form" class="form-grid">
                </form>
                <div class="modal-footer">
                    <button onclick="closeModal('student-details-modal')" class="secondary">關閉</button>
                </div>
            </div>
        </div>

        <div id="add-student-modal" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeModal('add-student-modal')">&times;</span>
                <div class="modal-header">
                    <h2 id="add-student-modal-title">新增推薦學生資料</h2>
                </div>
                <input type="hidden" id="add-student-target-program">
                <input type="hidden" id="add-student-target-semester">

                <form id="add-student-form" class="form-grid">
                    <div><label for="add-護照號碼" class="required">護照號碼:</label><input type="text" id="add-護照號碼" required
                            onblur="checkPassportIdExists(this.value, null)"> <span id="add-passport-check-msg"
                            class="error-message"></span></div>
                    <div><label for="add-英文姓名" class="required">英文姓名:</label><input type="text" id="add-英文姓名" required>
                    </div>
                    <div><label for="add-國籍" class="required">國籍:</label><select id="add-國籍" required></select></div>
                    <div><label for="add-身分證字號">身分證字號:</label><input type="text" id="add-身分證字號"></div>
                    <div><label for="add-出生年月日" class="required">出生年月日:</label><input type="date" id="add-出生年月日"
                            required></div>
                    <div><label class="required">生理性別:</label>
                        <div>
                            <input type="radio" name="add-生理性別" value="男" id="add-gender-male" required><label
                                for="add-gender-male" style="font-weight:normal; margin-right: 15px;">男</label>
                            <input type="radio" name="add-生理性別" value="女" id="add-gender-female"><label
                                for="add-gender-female" style="font-weight:normal;">女</label>
                        </div>
                    </div>
                    <div><label for="add-合作企業名稱" class="required">合作企業名稱:</label><input type="text" id="add-合作企業名稱"
                            required></div>
                    <div><label for="add-生活津貼" class="required">生活津貼:</label><input type="number" id="add-生活津貼" min="0"
                            max="10000" required></div>

                    <div class="full-width info-box" style="background-color: #f8f9fa;">
                        <h4 style="margin-top:0; border:none; padding:0;">專班資訊 (自動帶入)</h4>
                        <div class="form-grid">
                            <div><label>台灣開班學校名稱:</label><input type="text" id="add-台灣開班學校名稱" readonly class="readonly">
                            </div>
                            <div><label>台灣開班學校系所:</label><input type="text" id="add-台灣開班學校系所" readonly class="readonly">
                            </div>
                            <div><label>台灣專班名稱:</label><input type="text" id="add-台灣專班名稱" readonly class="readonly">
                            </div>
                            <div><label>台灣專班領域:</label><input type="text" id="add-台灣專班領域" readonly class="readonly">
                            </div>
                            <div><label>台灣專班學制:</label><input type="text" id="add-台灣專班學制" readonly class="readonly">
                            </div>
                            <div><label>台灣專班授課語言:</label><input type="text" id="add-台灣專班授課語言" readonly class="readonly">
                            </div>
                        </div>
                    </div>

                    <div class="full-width">
                        <h4 style="border-bottom: 1px solid #eee; padding-bottom: 5px;">來源學校資訊</h4>
                    </div>
                    <div><label for="add-當地在學畢業學校名稱" class="required">當地在學/畢業學校名稱:</label><input type="text"
                            id="add-當地在學畢業學校名稱" required></div>
                    <div><label class="required">當地學校是否為推薦清單內:</label>
                        <div>
                            <input type="radio" name="add-當地學校是否為推薦清單內之學校" value="是" id="add-recommend-yes"
                                required><label for="add-recommend-yes"
                                style="font-weight:normal; margin-right: 15px;">是</label>
                            <input type="radio" name="add-當地學校是否為推薦清單內之學校" value="否" id="add-recommend-no"><label
                                for="add-recommend-no" style="font-weight:normal;">否</label>
                        </div>
                    </div>
                    <div><label for="add-學校當地排名">學校當地排名:</label><input type="number" id="add-學校當地排名" min="0"></div>
                    <div><label for="add-學校國際排名">學校國際排名:</label><input type="number" id="add-學校國際排名" min="0"></div>

                    <div class="full-width">
                        <h4 style="border-bottom: 1px solid #eee; padding-bottom: 5px;">附件上傳 (限 PDF, <5MB)< /h4>
                    </div>
                    <div><label for="add-在校畢業成績單" class="required">在校/畢業成績單:</label><input type="file" id="add-在校畢業成績單"
                            accept=".pdf" required></div>
                    <div><label for="add-學校師長推薦信" class="required">學校師長推薦信:</label><input type="file" id="add-學校師長推薦信"
                            accept=".pdf" required></div>
                    <div><label for="add-其他具體學業表現優異證明" class="required">其他具體學業表現優異證明:</label><input type="file"
                            id="add-其他具體學業表現優異證明" accept=".pdf" required></div>
                    <div><label for="add-其他檢核資料" id="add-other-check-label">其他檢核資料:</label><input type="file"
                            id="add-其他檢核資料" accept=".pdf"></div>
                </form>
                <div class="modal-footer">
                    <button id="submit-add-student-btn" onclick="submitAddStudent()">確認送出</button>
                    <button onclick="closeModal('add-student-modal')" class="secondary">取消</button>
                </div>
            </div>
        </div>


        <div id="upload-receipt-modal" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeModal('upload-receipt-modal')">&times;</span>
                <div class="modal-header">
                    <h2 id="upload-receipt-title">上傳已蓋章清冊</h2>
                </div>
                <p>請下載系統產生的清冊，蓋章後掃描為 PDF 檔案再上傳。</p>
                <p><strong>專班:</strong> <span id="upload-receipt-program-name"></span></p>
                <p><strong>類型:</strong> <span id="upload-receipt-type"></span></p>
                <button onclick="simulateDownloadReceipt()" class="secondary"><i class="fas fa-download"></i> 下載清冊 PDF
                    (模擬)</button>
                <hr style="margin: 20px 0;">
                <label for="receipt-file-upload" style="font-weight: bold; display: block; margin-bottom: 10px;">選擇已蓋章的
                    PDF 檔案:</label>
                <input type="file" id="receipt-file-upload" accept=".pdf">
                <div class="modal-footer">
                    <button onclick="submitSignedReceipt()">確認上傳</button>
                    <button onclick="closeModal('upload-receipt-modal')" class="secondary">取消</button>
                </div>
            </div>
        </div>

    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>

    <script>
        const adminUser = { school: "國立台灣大學" };

        const allStudents = [
            { 護照號碼: "vH923022", 英文姓名: "Kyle Ramos", 國籍: "新加坡", 出生年月日: "1997-04-05", 生理性別: "男", 生活津貼: 9884, 當地在學畢業學校名稱: "Ruiz Group University", 當地學校是否為推薦清單內之學校: "否", 學校當地排名: 41, 學校國際排名: 590, 成績單檔名: "we.pdf", 推薦信檔名: "outside.pdf", 優異證明檔名: "two.pdf", 其他檢核資料檔名: "movie.pdf", 台灣開班學校名稱: "國立臺灣大學", 台灣開班學校系所: "國際金融產業學院", 台灣專班名稱: "112-1 國際金融人才教育專班", 台灣專班領域: "金融", 台灣專班學制: "碩士學位 (與本國生混班就讀)", 台灣專班授課語言: "英文", 合作企業名稱: "台灣銀行有限公司", 當學期入學情況: "已註冊", 身分證字號: "", 學期: "112-1", 註冊狀態: "已註冊", 未註冊原因: null, 補助_文件翻譯: 0, 補助_公證文件: 0, 補助_健康檢查: 0, 補助_單次簽證: 0, 補助_單程來台機票: 0, 補助_學雜費: 48000, 溢領費用: 0 },
            { 護照號碼: "Sa456428", 英文姓名: "Bob Stevenson", 國籍: "印尼", 出生年月日: "2003-07-19", 生理性別: "男", 生活津貼: 6529, 當地在學畢業學校名稱: "Taylor-Gill University", 當地學校是否為推薦清單內之學校: "是", 學校當地排名: 79, 學校國際排名: 673, 成績單檔名: "meet.pdf", 推薦信檔名: "he.pdf", 優異證明檔名: "poor.pdf", 其他檢核資料檔名: "field.pdf", 台灣開班學校名稱: "國立臺灣大學", 台灣開班學校系所: "國際金融產業學院", 台灣專班名稱: "112-1 國際金融人才教育專班", 台灣專班領域: "金融", 台灣專班學制: "碩士學位 (與本國生混班就讀)", 台灣專班授課語言: "英文", 合作企業名稱: "台灣銀行有限公司", 當學期入學情況: "已註冊", 身分證字號: "", 學期: "112-1", 註冊狀態: "已註冊", 未註冊原因: null, 補助_文件翻譯: 0, 補助_公證文件: 0, 補助_健康檢查: 0, 補助_單次簽證: 0, 補助_單程來台機票: 0, 補助_學雜費: 50000, 溢領費用: 0 },
            { 護照號碼: "VA599246", 英文姓名: "Angela Wheeler", 國籍: "印度", 出生年月日: "1999-12-22", 生理性別: "男", 生活津貼: 6066, 當地在學畢業學校名稱: "Allen Ltd University", 當地學校是否為推薦清單內之學校: "是", 學校當地排名: 5, 學校國際排名: 863, 成績單檔名: "line.pdf", 推薦信檔名: "human.pdf", 優異證明檔名: "see.pdf", 其他檢核資料檔名: "type.pdf", 台灣開班學校名稱: "國立臺灣大學", 台灣開班學校系所: "國際金融產業學院", 台灣專班名稱: "112-1 國際金融人才教育專班", 台灣專班領域: "金融", 台灣專班學制: "碩士學位 (與本國生混班就讀)", 台灣專班授課語言: "英文", 合作企業名稱: "台灣銀行有限公司", 當學期入學情況: "不註冊", 身分證字號: "", 學期: "112-1", 註冊狀態: "不註冊", 未註冊原因: "學生決定回國就業", 補助_文件翻譯: 0, 補助_公證文件: 0, 補助_健康檢查: 0, 補助_單次簽證: 0, 補助_單程來台機票: 0, 補助_學雜費: 0, 溢領費用: 53500 },
            { 護照號碼: "XQ960696", 英文姓名: "Carol Brown", 國籍: "泰國", 出生年月日: "1996-12-19", 生理性別: "女", 生活津貼: 9297, 當地在學畢業學校名稱: "Rose-Freeman University", 當地學校是否為推薦清單內之學校: "否", 學校當地排名: 67, 學校國際排名: 832, 成績單檔名: "option.pdf", 推薦信檔名: "PM.pdf", 優異證明檔名: "someone.pdf", 其他檢核資料檔名: "a.pdf", 台灣開班學校名稱: "國立臺灣大學", 台灣開班學校系所: "國際金融產業學院", 台灣專班名稱: "112-1 國際金融人才教育專班", 台灣專班領域: "金融", 台灣專班學制: "碩士學位 (與本國生混班就讀)", 台灣專班授課語言: "英文", 合作企業名稱: "台灣銀行有限公司", 當學期入學情況: "已註冊", 身分證字號: "", 學期: "112-1", 註冊狀態: "已註冊", 未註冊原因: null, 補助_文件翻譯: 0, 補助_公證文件: 0, 補助_健康檢查: 0, 補助_單次簽證: 0, 補助_單程來台機票: 0, 補助_學雜費: 49000, 溢領費用: 0 },
            { 護照號碼: "ZZ075470", 英文姓名: "Joshua Mccarty", 國籍: "日本", 出生年月日: "1995-09-15", 生理性別: "女", 生活津貼: 9748, 當地在學畢業學校名稱: "Anderson, Smith and Herring University", 當地學校是否為推薦清單內之學校: "否", 學校當地排名: 58, 學校國際排名: 505, 成績單檔名: "key.pdf", 推薦信檔名: "four.pdf", 優異證明檔名: "about.pdf", 其他檢核資料檔名: null, 台灣開班學校名稱: "國立臺灣大學", 台灣開班學校系所: "國際金融產業學院", 台灣專班名稱: "112-1 國際金融人才教育專班", 台灣專班領域: "金融", 台灣專班學制: "碩士學位 (與本國生混班就讀)", 台灣專班授課語言: "英文", 合作企業名稱: "台灣銀行有限公司", 當學期入學情況: "已註冊", 身分證字號: "", 學期: "112-1", 註冊狀態: "已註冊", 未註冊原因: null, 補助_文件翻譯: 0, 補助_公證文件: 0, 補助_健康檢查: 0, 補助_單次簽證: 0, 補助_單程來台機票: 0, 補助_學雜費: 50000, 溢領費用: 0 },
            { 護照號碼: "mh300891", 英文姓名: "Christina Turner", 國籍: "緬甸", 出生年月日: "1997-05-21", 生理性別: "男", 生活津貼: 7656, 當地在學畢業學校名稱: "Alvarez Group University", 當地學校是否為推薦清單內之學校: "是", 學校當地排名: 63, 學校國際排名: 602, 成績單檔名: "product.pdf", 推薦信檔名: "beat.pdf", 優異證明檔名: "age.pdf", 其他檢核資料檔名: null, 台灣開班學校名稱: "國立臺灣大學", 台灣開班學校系所: "國際金融產業學院", 台灣專班名稱: "112-1 國際金融人才教育專班", 台灣專班領域: "金融", 台灣專班學制: "碩士學位 (與本國生混班就讀)", 台灣專班授課語言: "英文", 合作企業名稱: "台灣銀行有限公司", 當學期入學情況: "已註冊", 身分證字號: "", 學期: "112-1", 註冊狀態: "已註冊", 未註冊原因: null, 補助_文件翻譯: 0, 補助_公證文件: 0, 補助_健康檢查: 0, 補助_單次簽證: 0, 補助_單程來台機票: 0, 補助_學雜費: 47500, 溢領費用: 0 },
            { 護照號碼: "PP471428", 英文姓名: "Shane Ramirez", 國籍: "日本", 出生年月日: "1994-08-08", 生理性別: "男", 生活津貼: 5132, 當地在學畢業學校名稱: "Williams Ltd University", 當地學校是否為推薦清單內之學校: "否", 學校當地排名: 15, 學校國際排名: 723, 成績單檔名: "event.pdf", 推薦信檔名: "open.pdf", 優異證明檔名: "forward.pdf", 其他檢核資料檔名: "your.pdf", 台灣開班學校名稱: "國立臺灣大學", 台灣開班學校系所: "國際金融產業學院", 台灣專班名稱: "112-1 國際金融人才教育專班", 台灣專班領域: "金融", 台灣專班學制: "碩士學位 (與本國生混班就讀)", 台灣專班授課語言: "英文", 合作企業名稱: "台灣銀行有限公司", 當學期入學情況: "已註冊", 身分證字號: "", 學期: "112-1", 註冊狀態: "已註冊", 未註冊原因: null, 補助_文件翻譯: 0, 補助_公證文件: 0, 補助_健康檢查: 0, 補助_單次簽證: 0, 補助_單程來台機票: 0, 補助_學雜費: 49500, 溢領費用: 0 },
            { 護照號碼: "OB590977", 英文姓名: "Joshua Clark", 國籍: "印尼", 出生年月日: "2004-04-10", 生理性別: "女", 生活津貼: 8490, 當地在學畢業學校名稱: "Smith-Hernandez University", 當地學校是否為推薦清單內之學校: "是", 學校當地排名: 13, 學校國際排名: 802, 成績單檔名: "goal.pdf", 推薦信檔名: "green.pdf", 優異證明檔名: "strategy.pdf", 其他檢核資料檔名: "hold.pdf", 台灣開班學校名稱: "國立臺灣大學", 台灣開班學校系所: "國際金融產業學院", 台灣專班名稱: "112-1 國際金融人才教育專班", 台灣專班領域: "金融", 台灣專班學制: "碩士學位 (與本國生混班就讀)", 台灣專班授課語言: "英文", 合作企業名稱: "台灣銀行有限公司", 當學期入學情況: "已註冊", 身分證字號: "", 學期: "112-1", 註冊狀態: "已註冊", 未註冊原因: null, 補助_文件翻譯: 0, 補助_公證文件: 0, 補助_健康檢查: 0, 補助_單次簽證: 0, 補助_單程來台機票: 0, 補助_學雜費: 50000, 溢領費用: 0 },
            { 護照號碼: "kj159004", 英文姓名: "Mrs. Jennifer Kelley", 國籍: "日本", 出生年月日: "1999-04-12", 生理性別: "男", 生活津貼: 9701, 當地在學畢業學校名稱: "Woods and Sons University", 當地學校是否為推薦清單內之學校: "是", 學校當地排名: 4, 學校國際排名: 128, 成績單檔名: "world.pdf", 推薦信檔名: "anything.pdf", 優異證明檔名: "foot.pdf", 其他檢核資料檔名: null, 台灣開班學校名稱: "國立臺灣大學", 台灣開班學校系所: "國際金融產業學院", 台灣專班名稱: "112-1 國際金融人才教育專班", 台灣專班領域: "金融", 台灣專班學制: "碩士學位 (與本國生混班就讀)", 台灣專班授課語言: "英文", 合作企業名稱: "台灣銀行有限公司", 當學期入學情況: "已註冊", 身分證字號: "", 學期: "112-1", 註冊狀態: "已註冊", 未註冊原因: null, 補助_文件翻譯: 0, 補助_公證文件: 0, 補助_健康檢查: 0, 補助_單次簽證: 0, 補助_單程來台機票: 0, 補助_學雜費: 48800, 溢領費用: 0 },
            { 護照號碼: "tA281465", 英文姓名: "Justin Olson", 國籍: "越南", 出生年月日: "2000-01-08", 生理性別: "男", 生活津貼: 8204, 當地在學畢業學校名稱: "Martinez-Wilson University", 當地學校是否為推薦清單內之學校: "是", 學校當地排名: 48, 學校國際排名: 854, 成績單檔名: "modern.pdf", 推薦信檔名: "last.pdf", 優異證明檔名: "always.pdf", 其他檢核資料檔名: null, 台灣開班學校名稱: "國立臺灣大學", 台灣開班學校系所: "國際金融產業學院", 台灣專班名稱: "112-1 國際金融人才教育專班", 台灣專班領域: "金融", 台灣專班學制: "碩士學位 (與本國生混班就讀)", 台灣專班授課語言: "英文", 合作企業名稱: "台灣銀行有限公司", 當學期入學情況: "已註冊", 身分證字號: "", 學期: "112-1", 註冊狀態: "已註冊", 未註冊原因: null, 補助_文件翻譯: 0, 補助_公證文件: 0, 補助_健康檢查: 0, 補助_單次簽證: 0, 補助_單程來台機票: 0, 補助_學雜費: 47000, 溢領費用: 0 },

            { 護照號碼: "zY660487", 英文姓名: "Tracy Howard", 國籍: "菲律賓", 出生年月日: "1998-01-01", 生理性別: "女", 生活津貼: 5331, 當地在學畢業學校名稱: "Taylor, Taylor and Davis University", 當地學校是否為推薦清單內之學校: "否", 學校當地排名: 66, 學校國際排名: 498, 成績單檔名: "successful.pdf", 推薦信檔名: "enough.pdf", 優異證明檔名: "where.pdf", 其他檢核資料檔名: "no.pdf", 台灣開班學校名稱: "國立台灣大學", 台灣開班學校系所: "國際半導體產業學院", 台灣專班名稱: "113-1 國際半導體人才教育專班", 台灣專班領域: "半導體", 台灣專班學制: "碩士學位 (與本國生混班就讀)", 台灣專班授課語言: "英文", 合作企業名稱: "台灣美光記憶體股份有限公司", 當學期入學情況: "準備註冊", 身分證字號: "", 學期: "113-1", 註冊狀態: "準備註冊", 未註冊原因: null, 補助_文件翻譯: 1500, 補助_公證文件: 2000, 補助_健康檢查: 3000, 補助_單次簽證: 1800, 補助_單程來台機票: 8500, 補助_學雜費: 49000, 溢領費用: 0 },
            { 護照號碼: "EJ924115", 英文姓名: "Jeffrey Carr", 國籍: "馬來西亞", 出生年月日: "1997-10-06", 生理性別: "女", 生活津貼: 7933, 當地在學畢業學校名稱: "Woods, Grimes and Green University", 當地學校是否為推薦清單內之學校: "是", 學校當地排名: 65, 學校國際排名: 143, 成績單檔名: "support.pdf", 推薦信檔名: "why.pdf", 優異證明檔名: "official.pdf", 其他檢核資料檔名: "whole.pdf", 台灣開班學校名稱: "國立台灣大學", 台灣開班學校系所: "國際半導體產業學院", 台灣專班名稱: "113-1 國際半導體人才教育專班", 台灣專班領域: "半導體", 台灣專班學制: "碩士學位 (與本國生混班就讀)", 台灣專班授課語言: "英文", 合作企業名稱: "台灣美光記憶體股份有限公司", 當學期入學情況: "準備註冊", 身分證字號: "", 學期: "113-1", 註冊狀態: "準備註冊", 未註冊原因: null, 補助_文件翻譯: 1200, 補助_公證文件: 1500, 補助_健康檢查: 2800, 補助_單次簽證: 1600, 補助_單程來台機票: 7800, 補助_學雜費: 50000, 溢領費用: 0 },
            { 護照號碼: "vp016097", 英文姓名: "Michele Brown", 國籍: "印度", 出生年月日: "2003-12-10", 生理性別: "女", 生活津貼: 9362, 當地在學畢業學校名稱: "Allen and Sons University", 當地學校是否為推薦清單內之學校: "是", 學校當地排名: 40, 學校國際排名: 102, 成績單檔名: "suggest.pdf", 推薦信檔名: "of.pdf", 優異證明檔名: "line.pdf", 其他檢核資料檔名: null, 台灣開班學校名稱: "國立台灣大學", 台灣開班學校系所: "國際半導體產業學院", 台灣專班名稱: "113-1 國際半導體人才教育專班", 台灣專班領域: "半導體", 台灣專班學制: "碩士學位 (與本國生混班就讀)", 台灣專班授課語言: "英文", 合作企業名稱: "台灣美光記憶體股份有限公司", 當學期入學情況: "準備註冊", 身分證字號: "", 學期: "113-1", 註冊狀態: "準備註冊", 未註冊原因: null, 補助_文件翻譯: 0, 補助_公證文件: 0, 補助_健康檢查: 0, 補助_單次簽證: 0, 補助_單程來台機票: 0, 補助_學雜費: 0, 溢領費用: 0 },
            { 護照號碼: "tJ115871", 英文姓名: "Calvin Cook", 國籍: "緬甸", 出生年月日: "2003-06-24", 生理性別: "女", 生活津貼: 9585, 當地在學畢業學校名稱: "Maynard PLC University", 當地學校是否為推薦清單內之學校: "是", 學校當地排名: 46, 學校國際排名: 445, 成績單檔名: "officer.pdf", 推薦信檔名: "people.pdf", 優異證明檔名: "field.pdf", 其他檢核資料檔名: "light.pdf", 台灣開班學校名稱: "國立台灣大學", 台灣開班學校系所: "國際半導體產業學院", 台灣專班名稱: "113-1 國際半導體人才教育專班", 台灣專班領域: "半導體", 台灣專班學制: "碩士學位 (與本國生混班就讀)", 台灣專班授課語言: "英文", 合作企業名稱: "台灣美光記憶體股份有限公司", 當學期入學情況: "特殊不註冊", 身分證字號: "", 學期: "113-1", 註冊狀態: "特殊不註冊", 未註冊原因: "意外身亡", 補助_文件翻譯: 0, 補助_公證文件: 0, 補助_健康檢查: 0, 補助_單次簽證: 0, 補助_單程來台機票: 0, 補助_學雜費: 0, 溢領費用: 0 },
            { 護照號碼: "sl196593", 英文姓名: "Cody Salazar", 國籍: "日本", 出生年月日: "1998-09-16", 生理性別: "女", 生活津貼: 8626, 當地在學畢業學校名稱: "Jones-Shelton University", 當地學校是否為推薦清單內之學校: "否", 學校當地排名: 8, 學校國際排名: 825, 成績單檔名: "case.pdf", 推薦信檔名: "under.pdf", 優異證明檔名: "citizen.pdf", 其他檢核資料檔名: null, 台灣開班學校名稱: "國立台灣大學", 台灣開班學校系所: "國際半導體產業學院", 台灣專班名稱: "113-1 國際半導體人才教育專班", 台灣專班領域: "半導體", 台灣專班學制: "碩士學位 (與本國生混班就讀)", 台灣專班授課語言: "英文", 合作企業名稱: "台灣美光記憶體股份有限公司", 當學期入學情況: "準備註冊", 身分證字號: "", 學期: "113-1", 註冊狀態: "不註冊", 未註冊原因: "環境適應不良", 補助_文件翻譯: 0, 補助_公證文件: 0, 補助_健康檢查: 0, 補助_單次簽證: 0, 補助_單程來台機票: 0, 補助_學雜費: 0, 溢領費用: 0 },
            { 護照號碼: "HZ018684", 英文姓名: "Daniel Shelton", 國籍: "柬埔寨", 出生年月日: "2001-06-03", 生理性別: "男", 生活津貼: 8267, 當地在學畢業學校名稱: "Hill, Vasquez and Davidson University", 當地學校是否為推薦清單內之學校: "是", 學校當地排名: 79, 學校國際排名: 506, 成績單檔名: "school.pdf", 推薦信檔名: "whom.pdf", 優異證明檔名: "student.pdf", 其他檢核資料檔名: null, 台灣開班學校名稱: "國立台灣大學", 台灣開班學校系所: "國際半導體產業學院", 台灣專班名稱: "113-1 國際半導體人才教育專班", 台灣專班領域: "半導體", 台灣專班學制: "碩士學位 (與本國生混班就讀)", 台灣專班授課語言: "英文", 合作企業名稱: "台灣美光記憶體股份有限公司", 當學期入學情況: "準備註冊", 身分證字號: "", 學期: "113-1", 註冊狀態: "準備註冊", 未註冊原因: null, 補助_文件翻譯: 0, 補助_公證文件: 0, 補助_健康檢查: 0, 補助_單次簽證: 0, 補助_單程來台機票: 0, 補助_學雜費: 0, 溢領費用: 0 },
            { 護照號碼: "LO515917", 英文姓名: "Connor Smith", 國籍: "緬甸", 出生年月日: "1998-11-24", 生理性別: "男", 生活津貼: 7664, 當地在學畢業學校名稱: "Thornton LLC University", 當地學校是否為推薦清單內之學校: "是", 學校當地排名: 25, 學校國際排名: 940, 成績單檔名: "study.pdf", 推薦信檔名: "conference.pdf", 優異證明檔名: "go.pdf", 其他檢核資料檔名: null, 台灣開班學校名稱: "國立台灣大學", 台灣開班學校系所: "國際半導體產業學院", 台灣專班名稱: "113-1 國際半導體人才教育專班", 台灣專班領域: "半導體", 台灣專班學制: "碩士學位 (與本國生混班就讀)", 台灣專班授課語言: "英文", 合作企業名稱: "台灣美光記憶體股份有限公司", 當學期入學情況: "準備註冊", 身分證字號: "", 學期: "113-1", 註冊狀態: "準備註冊", 未註冊原因: null, 補助_文件翻譯: 0, 補助_公證文件: 0, 補助_健康檢查: 0, 補助_單次簽證: 0, 補助_單程來台機票: 0, 補助_學雜費: 0, 溢領費用: 0 },
            { 護照號碼: "KO601230", 英文姓名: "Kimberly Becker", 國籍: "日本", 出生年月日: "1994-09-27", 生理性別: "男", 生活津貼: 9448, 當地在學畢業學校名稱: "Reid PLC University", 當地學校是否為推薦清單內之學校: "否", 學校當地排名: 12, 學校國際排名: 83, 成績單檔名: "then.pdf", 推薦信檔名: "parent.pdf", 優異證明檔名: "call.pdf", 其他檢核資料檔名: null, 台灣開班學校名稱: "國立台灣大學", 台灣開班學校系所: "國際半導體產業學院", 台灣專班名稱: "113-1 國際半導體人才教育專班", 台灣專班領域: "半導體", 台灣專班學制: "碩士學位 (與本國生混班就讀)", 台灣專班授課語言: "英文", 合作企業名稱: "台灣美光記憶體股份有限公司", 當學期入學情況: "準備註冊", 身分證字號: "", 學期: "113-1", 註冊狀態: "準備註冊", 未註冊原因: null, 補助_文件翻譯: 0, 補助_公證文件: 0, 補助_健康檢查: 0, 補助_單次簽證: 0, 補助_單程來台機票: 0, 補助_學雜費: 0, 溢領費用: 0 },
            { 護照號碼: "bm615109", 英文姓名: "Cathy Martinez", 國籍: "泰國", 出生年月日: "1997-11-13", 生理性別: "女", 生活津貼: 5893, 當地在學畢業學校名稱: "Owen, Giles and Johnson University", 當地學校是否為推薦清單內之學校: "否", 學校當地排名: 71, 學校國際排名: 299, 成績單檔名: "large.pdf", 推薦信檔名: "pressure.pdf", 優異證明檔名: "blood.pdf", 其他檢核資料檔名: null, 台灣開班學校名稱: "國立台灣大學", 台灣開班學校系所: "國際半導體產業學院", 台灣專班名稱: "113-1 國際半導體人才教育專班", 台灣專班領域: "半導體", 台灣專班學制: "碩士學位 (與本國生混班就讀)", 台灣專班授課語言: "英文", 合作企業名稱: "台灣美光記憶體股份有限公司", 當學期入學情況: "準備註冊", 身分證字號: "", 學期: "113-1", 註冊狀態: "準備註冊", 未註冊原因: null, 補助_文件翻譯: 0, 補助_公證文件: 0, 補助_健康檢查: 0, 補助_單次簽證: 0, 補助_單程來台機票: 0, 補助_學雜費: 0, 溢領費用: 0 },
            { 護照號碼: "Bl413145", 英文姓名: "John Carlson", 國籍: "泰國", 出生年月日: "2000-12-10", 生理性別: "女", 生活津貼: 9426, 當地在學畢業學校名稱: "Green Ltd University", 當地學校是否為推薦清單內之學校: "是", 學校當地排名: 78, 學校國際排名: 561, 成績單檔名: "many.pdf", 推薦信檔名: "this.pdf", 優異證明檔名: "week.pdf", 其他檢核資料檔名: null, 台灣開班學校名稱: "國立台灣大學", 台灣開班學校系所: "國際半導體產業學院", 台灣專班名稱: "113-1 國際半導體人才教育專班", 台灣專班領域: "半導體", 台灣專班學制: "碩士學位 (與本國生混班就讀)", 台灣專班授課語言: "英文", 合作企業名稱: "台灣美光記憶體股份有限公司", 當學期入學情況: "準備註冊", 身分證字號: "", 學期: "113-1", 註冊狀態: "準備註冊", 未註冊原因: null, 補助_文件翻譯: 0, 補助_公證文件: 0, 補助_健康檢查: 0, 補助_單次簽證: 0, 補助_單程來台機票: 0, 補助_學雜費: 0, 溢領費用: 0 },
            {
                護照號碼: "GN112233",
                英文姓名: "Carol Oldtimer",
                國籍: "新加坡",
                出生年月日: "1998-11-10",
                生理性別: "女",
                生活津貼: 8200,
                當地在學畢業學校名稱: "National University of Singapore",
                當地學校是否為推薦清單內之學校: "是",
                學校當地排名: 1,
                學校國際排名: 11,
                成績單檔名: "carol_transcript.pdf",
                推薦信檔名: "carol_rec.pdf",
                優異證明檔名: null,
                其他檢核資料檔名: "carol_other.pdf",
                台灣開班學校名稱: "國立台灣大學",
                台灣開班學校系所: "智慧製造學院",
                台灣專班名稱: "112-2 智慧製造人才專班",
                台灣專班領域: "智慧製造",
                台灣專班學制: "學士學位 (本國生混班就讀)",
                台灣專班授課語言: "中文",
                合作企業名稱: "研華股份有限公司",
                當學期入學情況: "準備註冊",
                身分證字號: "S1234567Z",
                學期: "112-2",
                註冊狀態: "準備註冊",
                未註冊原因: null,
                補助_文件翻譯: 0,
                補助_公證文件: 0,
                補助_健康檢查: 0,
                補助_單次簽證: 0,
                補助_單程來台機票: 0,
                補助_學雜費: 46000,
                溢領費用: 0
            },
            { 護照號碼: "GN123456", 英文姓名: "Alice Wonderland", 國籍: "越南", 出生年月日: "2000-01-15", 生理性別: "女", 生活津貼: 8000, 當地在學畢業學校名稱: "Vietnam National University", 當地學校是否為推薦清單內之學校: "是", 學校當地排名: 1, 學校國際排名: 150, 成績單檔名: "alice_transcript.pdf", 推薦信檔名: "alice_rec.pdf", 優異證明檔名: "alice_award.pdf", 其他檢核資料檔名: null, 台灣開班學校名稱: "國立台灣大學", 台灣開班學校系所: "智慧製造學院", 台灣專班名稱: "113-1 智慧製造人才專班", 台灣專班領域: "智慧製造", 台灣專班學制: "學士學位 (本國生混班就讀)", 台灣專班授課語言: "中文", 合作企業名稱: "台達電子工業股份有限公司", 當學期入學情況: "準備註冊", 身分證字號: "A234567890", 學期: "113-1", 註冊狀態: "準備註冊", 未註冊原因: null, 補助_文件翻譯: 2000, 補助_公證文件: 2500, 補助_健康檢查: 3500, 補助_單次簽證: 1000, 補助_單程來台機票: 9000, 補助_學雜費: 45000, 溢領費用: 0 },
            { 護照號碼: "GN654321", 英文姓名: "Bob Builder", 國籍: "泰國", 出生年月日: "1999-05-20", 生理性別: "男", 生活津貼: 7500, 當地在學畢業學校名稱: "Chulalongkorn University", 當地學校是否為推薦清單內之學校: "是", 學校當地排名: 1, 學校國際排名: 200, 成績單檔名: "bob_transcript.pdf", 推薦信檔名: "bob_rec.pdf", 優異證明檔名: null, 其他檢核資料檔名: "bob_other.pdf", 台灣開班學校名稱: "國立台灣大學", 台灣開班學校系所: "智慧製造學院", 台灣專班名稱: "113-1 智慧製造人才專班", 台灣專班領域: "智慧製造", 台灣專班學制: "學士學位 (本國生混班就讀)", 台灣專班授課語言: "中文", 合作企業名稱: "上銀科技股份有限公司", 當學期入學情況: "準備註冊", 身分證字號: "", 學期: "113-1", 註冊狀態: "準備註冊", 未註冊原因: null, 補助_文件翻譯: 500, 補助_公證文件: 1000, 補助_健康檢查: 2500, 補助_單次簽證: 1500, 補助_單程來台機票: 8800, 補助_學雜費: 48000, 溢領費用: 0 },
        ];

        let allPrograms = [
            { 學校名稱: "國立臺灣大學", 系所名稱: "國際金融產業學院", 專班名稱: "112-1 國際金融人才教育專班", 領域: "金融", 學制: "碩士學位 (與本國生混班就讀)", 授課語言: "英文", 學期: "112-1", 註冊補助提交狀態: "已通過", 不註冊提交狀態: "已通過", 退回原因_註冊補助: null, 退回原因_不註冊: null, 提交時間_註冊補助: "2024-09-15 10:00", 提交時間_不註冊: "2024-09-16 11:00", 蓋章清冊檔案_補助: "112-1_Fin_Subsidy_Signed.pdf", 蓋章清冊檔案_溢領: "112-1_Fin_Overpay_Signed.pdf", isNewSemester: false },
            { 學校名稱: "國立台灣大學", 系所名稱: "國際半導體產業學院", 專班名稱: "113-1 國際半導體人才教育專班", 領域: "半導體", 學制: "碩士學位 (與本國生混班就讀)", 授課語言: "英文", 學期: "113-1", 註冊補助提交狀態: "待提交", 不註冊提交狀態: "待提交", 退回原因_註冊補助: null, 退回原因_不註冊: null, 提交時間_註冊補助: null, 提交時間_不註冊: null, 蓋章清冊檔案_補助: null, 蓋章清冊檔案_溢領: null, isNewSemester: true },
            { 學校名稱: "國立台灣大學", 系所名稱: "智慧製造學院", 專班名稱: "113-1 智慧製造人才專班", 領域: "智慧製造", 學制: "學士學位 (本國生混班就讀)", 授課語言: "中文", 學期: "113-1", 註冊補助提交狀態: "已退回", 不註冊提交狀態: "不適用", 退回原因_註冊補助: "資料尚未填寫完全，請再確認。", 退回原因_不註冊: null, 提交時間_註冊補助: "2025-04-17 14:00", 提交時間_不註冊: null, 蓋章清冊檔案_補助: null, 蓋章清冊檔案_溢領: null, isNewSemester: true },
            {
                學校名稱: "國立台灣大學",
                系所名稱: "智慧製造學院",
                專班名稱: "112-2 智慧製造人才專班",
                領域: "智慧製造",
                學制: "學士學位 (本國生混班就讀)",
                授課語言: "中文",
                學期: "112-2",
                註冊補助提交狀態: "待提交",
                不註冊提交狀態: "不適用",
                退回原因_註冊補助: null,
                退回原因_不註冊: null,
                提交時間_註冊補助: null,
                提交時間_不註冊: null,
                蓋章清冊檔案_補助: null,
                蓋章清冊檔案_溢領: null,
                isNewSemester: false
            },
        ];

        let systemSettings = {
            openTimeActive: true,
            openTimeStart: "2025-04-15T09:00",
            openTimeEnd: "2025-04-30T17:00"
        };

        const managedPrograms = allPrograms.filter(p => p.學校名稱 === adminUser.school);
        let students = allStudents.filter(s => s.台灣開班學校名稱 === adminUser.school);

        const nationalities = ["柬埔寨", "印度", "印尼", "日本", "馬來西亞", "緬甸", "菲律賓", "新加坡", "泰國", "越南"];
        let currentUploadContext = null;
        let currentStudentListView = { programName: null, semester: null };

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            document.querySelector(`.nav-link[href="#${sectionId}"]`).classList.add('active');

            if (sectionId === 'dashboard') renderDashboard();
            if (sectionId === 'students') renderProgramListForStudentMgmt();
            if (sectionId === 'registration') populateProgramSelect('reg-program-select', 'registration');
            if (sectionId === 'not-registered') populateProgramSelect('nr-program-select', 'not-registered');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function getUniqueValues(data, key) {
            return [...new Set(data.map(item => item[key]))].sort();
        }

        function populateDropdown(selectId, options, valueKey = null, textKey = null) {
            const select = document.getElementById(selectId);
            select.innerHTML = `<option value="">請選擇</option>`;
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = valueKey ? option[valueKey] : option;
                opt.textContent = textKey ? option[textKey] : option;
                select.appendChild(opt);
            });
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return '-';
                return date.toLocaleString('sv-SE').replace(' ', ' ');
            } catch (e) { return '-'; }
        }

        function getStatusClass(status) {
            switch (status) {
                case '待提交': return 'status-待提交';
                case '待審核': return 'status-待審核';
                case '已退回': return 'status-已退回';
                case '已通過': return 'status-已通過';
                case '不適用': return 'status-不適用';
                default: return '';
            }
        }

        function checkOpenTime() {
            const noticeDiv = document.getElementById('access-time-notice');
            const now = new Date();
            const isActive = systemSettings.openTimeActive;
            const start = systemSettings.openTimeStart ? new Date(systemSettings.openTimeStart) : null;
            const end = systemSettings.openTimeEnd ? new Date(systemSettings.openTimeEnd) : null;

            let isOpen = false;
            let message = '';

            if (isActive && start && end && now >= start && now <= end) {
                isOpen = true;
                message = `編輯開放時間: ${formatDate(start)} - ${formatDate(end)}`;
                noticeDiv.className = 'access-notice alert alert-info';
            } else {
                message = `目前非資料編輯開放時間。`;
                noticeDiv.className = 'access-notice alert alert-warning';
            }
            noticeDiv.style.display = 'block';
            noticeDiv.textContent = message;
            return isOpen;
        }


        function enableEditing(enable) {
            const isOpen = checkOpenTime();
            const shouldEnable = isOpen && enable;

            const addStudentForProgramBtn = document.getElementById('add-student-for-program-btn');
            if (addStudentForProgramBtn) addStudentForProgramBtn.disabled = !isOpen;

            const submitAddStudentBtn = document.getElementById('submit-add-student-btn');
            if (submitAddStudentBtn) submitAddStudentBtn.disabled = !isOpen;

            document.querySelectorAll('#registration-form select, #registration-form input:not(.readonly), #registration-form button').forEach(el => {
                if (el.id !== 'reg-program-select' && !el.classList.contains('readonly')) {
                    if (el.tagName === 'BUTTON' && (el.id === 'reg-submit-btn' || el.id === 'reg-save-btn')) {
                        el.disabled = !shouldEnable;
                    } else if (el.tagName !== 'BUTTON') {
                        el.disabled = !shouldEnable;
                    }
                }
            });

            document.querySelectorAll('#not-registered-form textarea, #not-registered-form button').forEach(el => {
                if (el.id !== 'nr-program-select' && !el.classList.contains('readonly')) {
                    if (el.tagName === 'BUTTON' && (el.id === 'nr-submit-btn' || el.id === 'nr-save-btn')) {
                        el.disabled = !shouldEnable;
                    } else if (el.tagName !== 'BUTTON') {
                        el.disabled = !shouldEnable;
                    }
                }
            });
            const uploadBtnReg = document.getElementById('upload-receipt-btn');
            const uploadBtnNr = document.getElementById('upload-receipt-btn-nr');
            if (uploadBtnReg) uploadBtnReg.disabled = !isOpen;
            if (uploadBtnNr) uploadBtnNr.disabled = !isOpen;
        }

        function findProgram(programName, semester) {
            return managedPrograms.find(p => p.專班名稱 === programName && p.學期 === semester);
        }
        function findProgramByName(programName) {
            let program = managedPrograms.find(p => p.專班名稱 === programName);
            if (!program) {
                const baseName = programName.substring(programName.indexOf(' ') + 1);
                program = managedPrograms.find(p => p.專班名稱.endsWith(baseName));
            }
            return program;
        }
        function findStudent(passportId) {
            return students.find(s => s.護照號碼 === passportId);
        }

        function renderDashboard() {
            document.getElementById('school-admin-welcome-name').textContent = adminUser.school;
            const todoList = document.getElementById('todo-list');
            const programSummary = document.getElementById('program-summary');
            todoList.innerHTML = '';
            programSummary.innerHTML = '';
            let hasTodos = false;

            managedPrograms.forEach(p => {
                const studentsInProgram = students.filter(s => s.台灣專班名稱 === p.專班名稱 && s.學期 === p.學期).length;
                const summaryLi = document.createElement('li');
                summaryLi.style.marginBottom = '15px';
                summaryLi.innerHTML = `<strong>${p.專班名稱} (${p.學期})</strong>: ${studentsInProgram} 位學生
                    <div style="margin-left: 15px; font-size: 0.9em; margin-top: 5px;">
                        註冊補助狀態: <span class="${getStatusClass(p.註冊補助提交狀態)}">${p.註冊補助提交狀態}</span>
                        ${p.註冊補助提交狀態 === '已退回' ? ` <span class="error-message" style="display: inline;">(原因: ${p.退回原因_註冊補助})</span>` : ''}
                        <br> 不註冊狀態: <span class="${getStatusClass(p.不註冊提交狀態)}">${p.不註冊提交狀態}</span>
                        ${p.不註冊提交狀態 === '已退回' ? ` <span class="error-message" style="display: inline;">(原因: ${p.退回原因_不註冊})</span>` : ''}
                    </div>`;
                programSummary.appendChild(summaryLi);

                const addLi = (text, linkAction, isRejected = false) => {
                    const todoLi = document.createElement('li');
                    todoLi.innerHTML = `<a href="#" onclick="${linkAction}">${text}</a>`;
                    if (isRejected) todoLi.innerHTML += ` <span style="color:red; font-weight:bold;">(已退回)</span>`;
                    todoList.appendChild(todoLi);
                    hasTodos = true;
                };

                if (p.註冊補助提交狀態 === '待提交' || p.註冊補助提交狀態 === '已退回') {
                    const action = p.註冊補助提交狀態 === '待提交' ? '填寫並提交' : '修改並重新提交';
                    addLi(`${action} ${p.專班名稱} (${p.學期}) 的註冊與補助資料`,
                        `showSectionAndSelectProgram('registration', '${p.專班名稱}', '${p.學期}')`,
                        p.註冊補助提交狀態 === '已退回');
                }
                if (p.不註冊提交狀態 === '待提交' || p.不註冊提交狀態 === '已退回') {
                    const action = p.不註冊提交狀態 === '待提交' ? '填寫並提交' : '修改並重新提交';
                    addLi(`${action} ${p.專班名稱} (${p.學期}) 的不註冊學生資料`,
                        `showSectionAndSelectProgram('not-registered', '${p.專班名稱}', '${p.學期}')`,
                        p.不註冊提交狀態 === '已退回');
                }
                if (p.註冊補助提交狀態 === '已通過' && !p.蓋章清冊檔案_補助) {
                    addLi(`上傳 ${p.專班名稱} (${p.學期}) 已蓋章的補助清冊`,
                        `showSectionAndSelectProgram('registration', '${p.專班名稱}', '${p.學期}')`);
                }
                const needsOverpaymentReceipt = students.some(s => s.台灣專班名稱 === p.專班名稱 && s.學期 === p.學期 && s.溢領費用 > 0);
                if (p.不註冊提交狀態 === '已通過' && needsOverpaymentReceipt && !p.蓋章清冊檔案_溢領) {
                    addLi(`上傳 ${p.專班名稱} (${p.學期}) 已蓋章的溢領清冊`,
                        `showSectionAndSelectProgram('not-registered', '${p.專班名稱}', '${p.學期}')`);
                }
            });

            if (!hasTodos) {
                todoList.innerHTML = '<li>目前無待辦事項。</li>';
            }
        }

        function showSectionAndSelectProgram(sectionId, programName, semester) {
            showSection(sectionId);
            const selectId = sectionId === 'registration' ? 'reg-program-select' : 'nr-program-select';
            const selectElement = document.getElementById(selectId);
            const valueToSelect = `${programName}|${semester}`;
            if (selectElement) {
                selectElement.value = valueToSelect;
                if (sectionId === 'registration') {
                    renderRegistrationForm();
                } else if (sectionId === 'not-registered') {
                    renderNotRegisteredForm();
                }
            }
        }


        function renderProgramListForStudentMgmt() {
            const container = document.getElementById('program-list-container');
            const studentView = document.getElementById('student-list-view');
            const noProgramsMsg = document.getElementById('no-managed-programs');
            container.innerHTML = '<h2>請選擇要管理的專班</h2>';
            container.style.display = 'grid';
            studentView.style.display = 'none';

            if (managedPrograms.length === 0) {
                noProgramsMsg.style.display = 'block';
                container.innerHTML += noProgramsMsg.outerHTML;
                return;
            } else {
                noProgramsMsg.style.display = 'none';
            }

            managedPrograms.forEach(p => {
                const card = document.createElement('div');
                card.className = 'program-card';
                card.innerHTML = `
                    <h3>${p.專班名稱} (${p.學期})</h3>
                    <p>領域: ${p.領域} | 學制: ${p.學制} | 授課語言: ${p.授課語言}</p>
                    <div class="action-buttons">
                        <button onclick="viewProgramStudents('${p.專班名稱}', '${p.學期}')"><i class="fas fa-users"></i> 檢視學生列表</button>
                        <button onclick="openAddStudentModalForProgram('${p.專班名稱}', '${p.學期}')" class="secondary" ${!p.isNewSemester || !checkOpenTime() ? 'disabled' : ''} title="${!p.isNewSemester ? '只能為新學期專班新增學生' : (!checkOpenTime() ? '非編輯時間' : '')}"><i class="fas fa-user-plus"></i> 新增推薦學生</button>
                    </div>
                `;
                container.appendChild(card);
            });
            enableEditing(true);
        }

        function showProgramList() {
            document.getElementById('program-list-container').style.display = 'grid';
            document.getElementById('student-list-view').style.display = 'none';
            currentStudentListView = { programName: null, semester: null };
        }

        function viewProgramStudents(programName, semester) {
            currentStudentListView = { programName, semester };
            const program = findProgram(programName, semester);
            document.getElementById('program-list-container').style.display = 'none';
            const studentView = document.getElementById('student-list-view');
            studentView.style.display = 'block';

            document.getElementById('student-list-header').textContent = `學生列表: ${programName} (${semester})`;

            const tbody = document.getElementById('student-list-table').querySelector('tbody');
            tbody.innerHTML = '';

            const filteredStudents = students.filter(s => s.台灣專班名稱 === programName && s.學期 === semester);

            if (filteredStudents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">此專班尚無學生資料。</td></tr>';
            } else {
                filteredStudents.forEach(student => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                          <td>${student.護照號碼}</td>
                          <td>${student.英文姓名}</td>
                          <td>${student.國籍}</td>
                          <td>${student.當學期入學情況 || '未登錄'}</td>
                          <td class="action-buttons">
                              <button onclick="viewStudentDetails('${student.護照號碼}')" class="secondary"><i class="fas fa-eye"></i> 檢視</button>
                          </td>
                      `;

                    if (allStudents.filter(s_check => s_check.護照號碼 === student.護照號碼 && (s_check.台灣專班名稱 !== programName || s_check.學期 !== semester)).length > 0) {
                        row.classList.add('highlight');
                        const nameCell = row.cells[1];
                        nameCell.title = `ID 檢核: 該生曾被其他學校/專班推薦`;
                        nameCell.innerHTML += ` <span style="color: var(--warning-text); font-weight:bold;" title="該生曾被其他學校/專班推薦">(重複ID)</span>`;
                    }
                });
            }

            const addBtn = document.getElementById('add-student-for-program-btn');
            addBtn.disabled = !program.isNewSemester || !checkOpenTime();
            addBtn.title = !program.isNewSemester ? '只能為新學期專班新增學生' : (!checkOpenTime() ? '非編輯時間' : '');

        }


        function viewStudentDetails(passportId) {
            const student = findStudent(passportId);
            if (!student) return;

            const form = document.getElementById('student-details-form');
            form.innerHTML = '';
            form.dataset.passportId = passportId;

            const fields = [
                { id: '護照號碼', label: '護照號碼', type: 'text', readonly: true },
                { id: '英文姓名', label: '英文姓名', type: 'text', readonly: true },
                { id: '國籍', label: '國籍', type: 'select', options: nationalities, readonly: true },
                { id: '身分證字號', label: '身分證字號', type: 'text', readonly: true },
                { id: '出生年月日', label: '出生年月日', type: 'date', readonly: true },
                { id: '生理性別', label: '生理性別', type: 'radio', options: ['男', '女'], readonly: true },
                { id: '合作企業名稱', label: '合作企業名稱', type: 'text', readonly: true },
                { id: '生活津貼', label: '生活津貼', type: 'number', readonly: true },
                { id: '台灣開班學校名稱', label: '台灣開班學校名稱', type: 'text', readonly: true },
                { id: '台灣開班學校系所', label: '台灣開班學校系所', type: 'text', readonly: true },
                { id: '台灣專班名稱', label: '台灣專班名稱', type: 'text', readonly: true },
                { id: '學期', label: '學期', type: 'text', readonly: true },
                { id: '台灣專班領域', label: '台灣專班領域', type: 'text', readonly: true },
                { id: '台灣專班學制', label: '台灣專班學制', type: 'text', readonly: true },
                { id: '台灣專班授課語言', label: '台灣專班授課語言', type: 'text', readonly: true },
                { id: '當地在學畢業學校名稱', label: '當地在學/畢業學校名稱', type: 'text', readonly: true },
                { id: '當地學校是否為推薦清單內之學校', label: '當地學校是否為推薦清單內', type: 'radio', options: ['是', '否'], readonly: true },
                { id: '學校當地排名', label: '學校當地排名', type: 'number', readonly: true },
                { id: '學校國際排名', label: '學校國際排名', type: 'number', readonly: true },

                { id: '成績單檔名', label: '在校/畢業成績單', type: 'text', readonly: true, value: student.成績單檔名 || '未提供' },
                { id: '推薦信檔名', label: '學校師長推薦信', type: 'text', readonly: true, value: student.推薦信檔名 || '未提供' },
                { id: '優異證明檔名', label: '其他具體學業表現優異證明', type: 'text', readonly: true, value: student.優異證明檔名 || '未提供' },
                { id: '其他檢核資料檔名', label: '其他檢核資料', type: 'text', readonly: true, value: student.其他檢核資料檔名 || '未提供' },
            ];

            fields.forEach(field => {
                const div = document.createElement('div');
                if (field.id.includes('檔名')) { div.classList.add('full-width'); }

                let inputHtml = '';

                const currentValue = field.value !== undefined ? field.value : (student[field.id] || '');
                const isReadonly = field.readonly;

                if (field.type === 'select') {
                    inputHtml = `<select id="detail-${field.id}" disabled class="readonly">`;
                    field.options.forEach(opt => {
                        inputHtml += `<option value="${opt}" ${currentValue === opt ? 'selected' : ''}>${opt}</option>`;
                    });
                    inputHtml += `</select>`;
                } else if (field.type === 'radio') {
                    inputHtml = `<div style="padding-top: 8px;">` + field.options.map(opt => `
                         <input type="radio" name="detail-${field.id}" id="detail-${field.id}-${opt}" value="${opt}" ${currentValue === opt ? 'checked' : ''} disabled class="readonly">
                         <label for="detail-${field.id}-${opt}" style="font-weight:normal; margin-right: 15px;">${opt}</label>
                     `).join('') + `</div>`;
                } else {
                    inputHtml = `<input type="${field.type}" id="detail-${field.id}" value="${currentValue}" readonly class="readonly">`;
                }

                div.innerHTML = `<label for="detail-${field.id}">${field.label}:</label>${inputHtml}`;
                form.appendChild(div);
            });

            openModal('student-details-modal');
        }


        function openAddStudentModalForSelectedProgram() {

            const { programName, semester } = currentStudentListView;
            if (!programName || !semester) {
                alert("請先選擇一個專班。");
                return;
            }
            openAddStudentModalForProgram(programName, semester);
        }

        function openAddStudentModalForProgram(programName, semester) {
            if (!checkOpenTime()) {
                alert('目前非資料編輯開放時間，無法新增學生。');
                return;
            }
            const program = findProgram(programName, semester);
            if (!program || !program.isNewSemester) {
                alert('只能為新學期的專班新增學生。');
                return;
            }


            document.getElementById('add-student-form').reset();
            document.getElementById('add-passport-check-msg').textContent = '';
            document.getElementById('add-other-check-label').classList.remove('required');
            document.getElementById('add-其他檢核資料').required = false;


            document.getElementById('add-student-modal-title').textContent = `新增推薦學生至: ${programName} (${semester})`;
            document.getElementById('add-student-target-program').value = programName;
            document.getElementById('add-student-target-semester').value = semester;


            populateDropdown('add-國籍', nationalities);


            populateAddStudentProgramDetails(program);

            openModal('add-student-modal');
        }

        function populateAddStudentProgramDetails(program) {
            const programDetailFields = ['台灣開班學校名稱', '台灣開班學校系所', '台灣專班名稱', '台灣專班領域', '台灣專班學制', '台灣專班授課語言'];
            if (program) {
                document.getElementById('add-台灣開班學校名稱').value = program.學校名稱;
                document.getElementById('add-台灣開班學校系所').value = program.系所名稱;
                document.getElementById('add-台灣專班名稱').value = program.專班名稱;
                document.getElementById('add-台灣專班領域').value = program.領域;
                document.getElementById('add-台灣專班學制').value = program.學制;
                document.getElementById('add-台灣專班授課語言').value = program.授課語言;


                const isMixedBachelor = program.學制 && program.學制.includes("本國生混班之學士班");
                const otherCheckLabel = document.getElementById('add-other-check-label');
                const otherCheckInput = document.getElementById('add-其他檢核資料');
                if (isMixedBachelor) {
                    otherCheckLabel.classList.add('required');
                    otherCheckInput.required = true;
                } else {
                    otherCheckLabel.classList.remove('required');
                    otherCheckInput.required = false;
                }
            } else {

                programDetailFields.forEach(id => document.getElementById(`add-${id}`).value = '');
                document.getElementById('add-other-check-label').classList.remove('required');
                document.getElementById('add-其他檢核資料').required = false;
            }
        }

        function checkPassportIdExists(passportId, currentEditingId = null) {
            if (!passportId) return;
            const existingStudent = allStudents.find(s => s.護照號碼 === passportId && s.護照號碼 !== currentEditingId);
            const msgElementId = currentEditingId ? 'detail-passport-check-msg' : 'add-passport-check-msg';
            const msgElement = document.getElementById(msgElementId);
            const inputElement = document.getElementById(currentEditingId ? `detail-護照號碼` : `add-護照號碼`);

            if (existingStudent) {
                msgElement.textContent = `ID 檢核: 該生曾被 ${existingStudent.台灣開班學校名稱} ${existingStudent.台灣專班名稱} (${existingStudent.學期}) 推薦`;
                inputElement?.classList.add('error');
            } else {
                msgElement.textContent = '';
                inputElement?.classList.remove('error');
            }
        }

        function submitAddStudent() {
            if (!checkOpenTime()) {
                alert('已超過編輯開放時間，無法提交。');
                return;
            }
            const form = document.getElementById('add-student-form');
            if (!form.checkValidity()) {
                alert('請填寫所有必填欄位 (*)，並檢查是否有錯誤提示。');

                form.reportValidity();

                form.querySelectorAll(':invalid').forEach(el => el.classList.add('error'));
                return;
            }

            form.querySelectorAll('.error').forEach(el => el.classList.remove('error'));


            const passportId = document.getElementById('add-護照號碼').value;
            if (allStudents.some(s => s.護照號碼 === passportId)) {
                console.warn(`ID "${passportId}" 已存在於系統中。`);

            }

            const newStudent = {};
            const formData = new FormData(form);

            formData.forEach((value, key) => {
                const mappedKey = key.startsWith('add-') ? key.substring(4) : key;
                if (mappedKey === '生理性別' || mappedKey === '當地學校是否為推薦清單內之學校') {
                    newStudent[mappedKey] = form.querySelector(`input[name="${key}"]:checked`)?.value || '';
                } else if (!(value instanceof File)) {
                    newStudent[mappedKey] = value;
                }
            });


            const programName = document.getElementById('add-student-target-program').value;
            const semester = document.getElementById('add-student-target-semester').value;
            const programDetails = findProgram(programName, semester);

            if (!programDetails) {
                alert("無法找到目標專班資訊，請重試。");
                return;
            }

            newStudent['台灣開班學校名稱'] = programDetails.學校名稱;
            newStudent['台灣開班學校系所'] = programDetails.系所名稱;
            newStudent['台灣專班名稱'] = programName;
            newStudent['台灣專班領域'] = programDetails.領域;
            newStudent['台灣專班學制'] = programDetails.學制;
            newStudent['台灣專班授課語言'] = programDetails.授課語言;
            newStudent['學期'] = semester;


            newStudent['成績單檔名'] = document.getElementById('add-在校畢業成績單').files[0]?.name || null;
            newStudent['推薦信檔名'] = document.getElementById('add-學校師長推薦信').files[0]?.name || null;
            newStudent['優異證明檔名'] = document.getElementById('add-其他具體學業表現優異證明').files[0]?.name || null;
            newStudent['其他檢核資料檔名'] = document.getElementById('add-其他檢核資料').files[0]?.name || null;


            newStudent.當學期入學情況 = "準備註冊";
            newStudent.註冊狀態 = "準備註冊";
            ['未註冊原因', '補助_文件翻譯', '補助_公證文件', '補助_健康檢查', '補助_單次簽證', '補助_單程來台機票', '補助_學雜費', '溢領費用'].forEach(k => newStudent[k] = newStudent[k] === undefined ? 0 : (newStudent[k] || 0));
            newStudent.溢領費用 = 0;



            students.push(newStudent);
            allStudents.push(newStudent);

            alert(`學生 ${newStudent.英文姓名} 資料已新增 (狀態: 準備註冊)。\n請至「註冊與補助登錄」頁面更新狀態。`);
            closeModal('add-student-modal');

            if (currentStudentListView.programName === programName && currentStudentListView.semester === semester) {
                viewProgramStudents(programName, semester);
            }
            renderDashboard();
        }


        function populateProgramSelect(selectId, type) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">請選擇</option>';
            managedPrograms.forEach(p => {
                const statusKey = type === 'registration' ? '註冊補助提交狀態' : '不註冊提交狀態';
                const status = p[statusKey];


                const opt = document.createElement('option');
                opt.value = `${p.專班名稱}|${p.學期}`;
                opt.textContent = `${p.專班名稱} (${p.學期}) - [${status || 'N/A'}]`;
                opt.classList.add(getStatusClass(status));
                select.appendChild(opt);
            });

            const contentId = type === 'registration' ? 'registration-content' : 'not-registered-content';
            document.getElementById(contentId).innerHTML = '<p class="alert alert-info" style="margin-top: 0;">請從上方選擇一個專班以檢視或編輯資料。</p>';
        }

        function renderRegistrationForm() {
            const selectedValue = document.getElementById('reg-program-select').value;
            const contentDiv = document.getElementById('registration-content');
            contentDiv.innerHTML = '';

            if (!selectedValue) {
                contentDiv.innerHTML = '<p class="alert alert-info" style="margin-top: 0;">請從上方選擇一個專班以檢視或編輯資料。</p>';
                return;
            }

            const [programName, semester] = selectedValue.split('|');
            const program = findProgram(programName, semester);
            const programStudents = students.filter(s => s.台灣專班名稱 === programName && s.學期 === semester);

            if (!program) { contentDiv.innerHTML = '<p class="alert alert-danger">錯誤：找不到專班資料。</p>'; return; }


            let statusHTML = `<div class="info-box"><h4>專班狀態: <span class="${getStatusClass(program.註冊補助提交狀態)}">${program.註冊補助提交狀態}</span></h4>`;
            if (program.註冊補助提交狀態 === '已退回') {
                statusHTML += `<div class="alert alert-danger">退回原因: ${program.退回原因_註冊補助 || '無明確原因'}</div>`;
            } else if (program.註冊補助提交狀態 === '已通過') {
                statusHTML += `<div class="alert alert-success">此專班資料已審核通過。</div>`;
                if (program.蓋章清冊檔案_補助) {
                    statusHTML += `<p style="margin-top: 10px;">已上傳蓋章補助清冊: <strong>${program.蓋章清冊檔案_補助}</strong></p>`;
                } else {
                    statusHTML += `<button id="upload-receipt-btn" class="warning" style="margin-top: 10px;" onclick="openUploadReceiptModal('${programName}', '${semester}', '補助')"><i class="fas fa-upload"></i> 上傳已蓋章補助清冊</button>`;
                }
            } else if (program.註冊補助提交狀態 === '待審核') {
                statusHTML += `<div class="alert alert-info">資料已提交，等待管理員審核中...</div>`;
            }
            statusHTML += `</div>`;
            contentDiv.innerHTML += statusHTML;

            const isEditable = (program.註冊補助提交狀態 === '待提交' || program.註冊補助提交狀態 === '已退回');
            const isOpen = checkOpenTime();
            const finalEditable = isOpen && isEditable;

            let formHTML = `<form id="registration-form"><div class="table-container"><table id="registration-table"><thead><tr>
                <th>英文姓名</th><th>護照號碼</th><th class="required">註冊狀態</th>
                <th>文件<br>翻譯</th><th>公證<br>文件</th><th>健康<br>檢查</th><th>單次<br>簽證</th><th>行政費<br>(上限1萬)</th>
                <th>機票<br>(上限9千)</th><th class="required">學雜費<br>(上限5萬)</th><th>補助<br>合計</th>
                <th>提示</th>
                </tr></thead><tbody>`;

            if (programStudents.length === 0) {
                formHTML += '<tr><td colspan="12" style="text-align: center; padding: 20px;">此專班目前無學生資料，請至「學生資料管理」新增。</td></tr>';
            } else {
                programStudents.forEach((s, index) => {
                    const rowId = `student-${s.護照號碼}`;
                    const isNew = program.isNewSemester;
                    let previousTuition = '';



                    const ensureNum = (val) => (typeof val === 'number' ? val : (parseInt(val, 10) || 0));
                    const adminFeeTotal = Math.min(10000, ensureNum(s.補助_文件翻譯) + ensureNum(s.補助_公證文件) + ensureNum(s.補助_健康檢查) + ensureNum(s.補助_單次簽證));
                    const ticketFee = Math.min(9000, ensureNum(s.補助_單程來台機票));
                    const tuitionFee = Math.min(50000, ensureNum(s.補助_學雜費));
                    const totalSubsidy = (s.註冊狀態 === '已註冊') ? (adminFeeTotal + ticketFee + tuitionFee) : 0;

                    formHTML += `<tr id="${rowId}">
                          <td>${s.英文姓名}</td>
                          <td>${s.護照號碼}</td>
                          <td>
                              <select name="註冊狀態_${s.護照號碼}" onchange="handleRegistrationStatusChange('${s.護照號碼}', this.value, ${isNew})" ${!finalEditable ? 'disabled class="readonly"' : ''}>
                                  <option value="準備註冊" ${s.註冊狀態 === '準備註冊' ? 'selected' : ''} disabled>準備註冊</option>
                                  <!-- Removed '待註冊' -->
                                  <option value="已註冊" ${s.註冊狀態 === '已註冊' ? 'selected' : ''}>已註冊</option>
                                  <option value="不註冊" ${s.註冊狀態 === '不註冊' ? 'selected' : ''}>不註冊</option>
                                  <option value="特殊不註冊" ${s.註冊狀態 === '特殊不註冊' ? 'selected' : ''}>特殊不註冊</option>
                              </select>
                          </td>
                          <td><input type="number" class="subsidy-input admin-fee" name="補助_文件翻譯_${s.護照號碼}" value="${ensureNum(s.補助_文件翻譯)}" min="0" oninput="updateTotals('${s.護照號碼}')" ${!finalEditable || !isNew || s.註冊狀態 !== '已註冊' ? 'disabled class="readonly"' : ''}></td>
                          <td><input type="number" class="subsidy-input admin-fee" name="補助_公證文件_${s.護照號碼}" value="${ensureNum(s.補助_公證文件)}" min="0" oninput="updateTotals('${s.護照號碼}')" ${!finalEditable || !isNew || s.註冊狀態 !== '已註冊' ? 'disabled class="readonly"' : ''}></td>
                          <td><input type="number" class="subsidy-input admin-fee" name="補助_健康檢查_${s.護照號碼}" value="${ensureNum(s.補助_健康檢查)}" min="0" oninput="updateTotals('${s.護照號碼}')" ${!finalEditable || !isNew || s.註冊狀態 !== '已註冊' ? 'disabled class="readonly"' : ''}></td>
                          <td><input type="number" class="subsidy-input admin-fee" name="補助_單次簽證_${s.護照號碼}" value="${ensureNum(s.補助_單次簽證)}" min="0" oninput="updateTotals('${s.護照號碼}')" ${!finalEditable || !isNew || s.註冊狀態 !== '已註冊' ? 'disabled class="readonly"' : ''}></td>
                          <td><input type="number" class="subsidy-input readonly" id="admin-total_${s.護照號碼}" value="${adminFeeTotal}" readonly></td>
                          <td><input type="number" class="subsidy-input" name="補助_單程來台機票_${s.護照號碼}" value="${ensureNum(s.補助_單程來台機票)}" min="0" max="9000" oninput="updateTotals('${s.護照號碼}')" ${!finalEditable || !isNew || s.註冊狀態 !== '已註冊' ? 'disabled class="readonly"' : ''}></td>
                          <td>
                              <input type="number" class="subsidy-input" name="補助_學雜費_${s.護照號碼}" value="${ensureNum(s.補助_學雜費)}" min="0" max="50000" oninput="updateTotals('${s.護照號碼}')" ${!finalEditable || s.註冊狀態 !== '已註冊' ? 'disabled class="readonly"' : ''}>
                              ${!isNew && previousTuition ? '<span class="alert-info" style="font-size:0.8em; padding:2px; display: block; margin-top: 3px;">自動帶入上學期金額，請確認</span>' : ''}
                          </td>
                          <td><input type="number" class="subsidy-input readonly" id="total-subsidy_${s.護照號碼}" value="${totalSubsidy}" readonly></td>
                          <td id="not-registered-msg_${s.護照號碼}" class="error-message" style="font-size:0.85em; line-height: 1.3;">${(s.註冊狀態 === '不註冊' || s.註冊狀態 === '特殊不註冊') ? '請至「不註冊學生登錄」頁面填寫原因。' : ''}</td>
                      </tr>`;
                });
            }

            formHTML += `</tbody></table></div>`;

            if (programStudents.length > 0) {
                if (finalEditable) {
                    formHTML += `<div class="sticky-actions action-buttons">
                         <button type="button" id="reg-save-btn" onclick="saveRegistrationData('${programName}', '${semester}')" class="warning"><i class="fas fa-save"></i> 暫存</button>
                         <button type="button" id="reg-submit-btn" onclick="submitRegistrationData('${programName}', '${semester}')"><i class="fas fa-paper-plane"></i> 提交審核</button>
                     </div>`;
                } else if (!isOpen && isEditable) {
                    formHTML += `<div class="alert alert-warning sticky-actions" style="text-align:center;">目前非編輯開放時間，無法儲存或提交。</div>`;
                }
            } else if (programStudents.length === 0 && finalEditable) {
                formHTML += `<div class="alert alert-warning sticky-actions" style="text-align:center;">無學生資料可提交。</div>`;
            }


            formHTML += `</form>`;
            contentDiv.innerHTML += formHTML;


            programStudents.forEach(s => {
                handleRegistrationStatusChange(s.護照號碼, s.註冊狀態, program.isNewSemester);
            });
            enableEditing(isEditable);
        }


        function handleRegistrationStatusChange(passportId, status, isNewSemester) {
            console.log(`--- handleRegistrationStatusChange ---`);
            console.log(`Passport ID: ${passportId}, New Status: ${status}, Is New Semester: ${isNewSemester}`);

            const row = document.getElementById(`student-${passportId}`);
            if (!row) {
                console.error(`Row not found for ${passportId}`);
                return;
            }


            const isOpen = checkOpenTime();
            const programValue = document.getElementById('reg-program-select').value;
            if (!programValue) { console.warn("No program selected."); return; }
            const [programName, semester] = programValue.split('|');
            const program = findProgram(programName, semester);
            if (!program) { console.error("Program not found:", programName, semester); return; }

            const isProgramEditable = (program.註冊補助提交狀態 === '待提交' || program.註冊補助提交狀態 === '已退回');
            const canEditNow = isOpen && isProgramEditable;

            console.log(`Program: ${programName}, Program Status: ${program.註冊補助提交狀態}`);
            console.log(`Is Open Time: ${isOpen}, Is Program Editable Status: ${isProgramEditable}, Can Edit Now: ${canEditNow}`);

            const notRegisteredMsg = row.querySelector(`#not-registered-msg_${passportId}`);


            const studentIndex = students.findIndex(s => s.護照號碼 === passportId);
            if (studentIndex !== -1) {
                students[studentIndex].註冊狀態 = status;

                if (status === '已註冊') students[studentIndex].當學期入學情況 = '已註冊';
                else if (status === '不註冊') students[studentIndex].當學期入學情況 = '不註冊';
                else if (status === '特殊不註冊') students[studentIndex].當學期入學情況 = '特殊不註冊';
                else students[studentIndex].當學期入學情況 = '準備註冊';


                if (status !== '已註冊') {
                    ['補助_文件翻譯', '補助_公證文件', '補助_健康檢查', '補助_單次簽證', '補助_單程來台機票', '補助_學雜費'].forEach(key => {
                        students[studentIndex][key] = 0;
                    });
                }
            }



            const statusSelect = row.querySelector(`select[name="註冊狀態_${passportId}"]`);
            if (statusSelect) {
                statusSelect.disabled = !canEditNow;
                console.log(`Status Select (${statusSelect.name}): Disabled = ${!canEditNow}`);
                if (!canEditNow) statusSelect.classList.add('readonly'); else statusSelect.classList.remove('readonly');
            }


            const subsidyFields = ['補助_文件翻譯', '補助_公證文件', '補助_健康檢查', '補助_單次簽證', '補助_單程來台機票', '補助_學雜費'];
            subsidyFields.forEach(fieldName => {
                const input = row.querySelector(`input[name="${fieldName}_${passportId}"]`);
                if (input) {
                    let shouldBeEnabled = false;
                    let reason = "";


                    if (canEditNow) {

                        if (status === '已註冊') {
                            reason = `CanEditNow=true, Status='已註冊'.`;

                            if (isNewSemester) {

                                shouldBeEnabled = true;
                                reason += ` Is New Semester. Enabling.`
                            } else {

                                if (fieldName === '補助_學雜費') {
                                    shouldBeEnabled = true;
                                    reason += ` Is Old Semester, Field is '學雜費'. Enabling.`
                                } else {

                                    input.value = 0;
                                    shouldBeEnabled = false;
                                    reason += ` Is Old Semester, Field is not '學雜費'. Disabling & Zeroing.`
                                }
                            }
                        } else {

                            input.value = 0;
                            shouldBeEnabled = false;
                            reason = `CanEditNow=true, but Status is NOT '已註冊' (${status}). Disabling & Zeroing.`
                        }
                    } else {

                        if (status !== '已註冊') input.value = 0;
                        shouldBeEnabled = false;
                        reason = `CanEditNow=false. Disabling.`
                    }


                    input.disabled = !shouldBeEnabled;
                    console.log(`Input ${input.name}: Should be enabled: ${shouldBeEnabled}. Reason: ${reason}. Final Disabled State: ${input.disabled}`);
                    if (!shouldBeEnabled) {
                        input.classList.add('readonly');
                    } else {
                        input.classList.remove('readonly');
                    }
                } else {
                    console.warn(`Input not found for field ${fieldName}_${passportId}`);
                }
            });



            if (status === '不註冊' || status === '特殊不註冊') {
                notRegisteredMsg.textContent = '請至「不註冊學生登錄」頁面填寫原因。';
            } else {
                notRegisteredMsg.textContent = '';
            }


            updateTotals(passportId);
            console.log(`--- End handleRegistrationStatusChange for ${passportId} ---`);
        }

        function updateTotals(passportId) {
            const row = document.getElementById(`student-${passportId}`);
            if (!row) return;

            const student = findStudent(passportId);
            const adminTotalEl = row.querySelector(`#admin-total_${passportId}`);
            const totalSubsidyEl = row.querySelector(`#total-subsidy_${passportId}`);

            if (!student || student.註冊狀態 !== '已註冊') {
                if (adminTotalEl) adminTotalEl.value = 0;
                if (totalSubsidyEl) totalSubsidyEl.value = 0;
                return;
            }

            const parseVal = (selector) => {
                const input = row.querySelector(selector);

                if (input) input.style.border = '';

                const val = parseInt(input?.value, 10);
                return isNaN(val) ? 0 : val;
            };

            const trans = parseVal(`input[name="補助_文件翻譯_${passportId}"]`);
            const notar = parseVal(`input[name="補助_公證文件_${passportId}"]`);
            const health = parseVal(`input[name="補助_健康檢查_${passportId}"]`);
            const visa = parseVal(`input[name="補助_單次簽證_${passportId}"]`);
            const ticketVal = parseVal(`input[name="補助_單程來台機票_${passportId}"]`);
            const tuitionVal = parseVal(`input[name="補助_學雜費_${passportId}"]`);


            const adminTotal = Math.min(10000, trans + notar + health + visa);
            const cappedTicket = Math.min(9000, ticketVal);
            const cappedTuition = Math.min(50000, tuitionVal);


            if (adminTotalEl) adminTotalEl.value = adminTotal;
            if (totalSubsidyEl) totalSubsidyEl.value = adminTotal + cappedTicket + cappedTuition;


            const ticketInput = row.querySelector(`input[name="補助_單程來台機票_${passportId}"]`);
            const tuitionInput = row.querySelector(`input[name="補助_學雜費_${passportId}"]`);
            if (ticketInput && ticketVal > 9000) ticketInput.style.border = '2px solid var(--red)';
            if (tuitionInput && tuitionVal > 50000) tuitionInput.style.border = '2px solid var(--red)';



            const studentIndex = students.findIndex(s => s.護照號碼 === passportId);
            if (studentIndex !== -1) {
                students[studentIndex].補助_文件翻譯 = trans;
                students[studentIndex].補助_公證文件 = notar;
                students[studentIndex].補助_健康檢查 = health;
                students[studentIndex].補助_單次簽證 = visa;
                students[studentIndex].補助_單程來台機票 = ticketVal;
                students[studentIndex].補助_學雜費 = tuitionVal;
            }
        }

        function saveRegistrationData(programName, semester) {
            if (!checkOpenTime()) {
                alert('已超過編輯開放時間，無法暫存。');
                return;
            }

            console.log("Simulating saving registration data for:", programName, semester, students);
            alert('資料已暫存 (模擬)。請記得在開放時間內提交審核。');

        }

        function submitRegistrationData(programName, semester) {
            if (!checkOpenTime()) {
                alert('已超過編輯開放時間，無法提交。');
                return;
            }

            const programIndex = managedPrograms.findIndex(p => p.專班名稱 === programName && p.學期 === semester);
            if (programIndex === -1) { alert('錯誤：找不到專班資料'); return; }

            const programStudents = students.filter(s => s.台灣專班名稱 === programName && s.學期 === semester);
            const hasPendingStatus = programStudents.some(s => s.註冊狀態 === '準備註冊');
            if (hasPendingStatus) {
                if (!confirm('提醒：尚有學生的註冊狀態為 "準備註冊"，此狀態無法提交。請將所有學生更新為 "已註冊"、"不註冊" 或 "特殊不註冊" 後再提交。\n\n(此為模擬提示，實際系統可能直接阻擋)')) {



                }
            }

            let hasOverCap = false;
            let overCapMessages = [];
            programStudents.forEach(s => {
                if (s.註冊狀態 === '已註冊') {
                    if ((s.補助_單程來台機票 || 0) > 9000) {
                        hasOverCap = true;
                        overCapMessages.push(`${s.英文姓名} 的機票費用`);
                    }
                    if ((s.補助_學雜費 || 0) > 50000) {
                        hasOverCap = true;
                        overCapMessages.push(`${s.英文姓名} 的學雜費`);
                    }
                }
            });
            if (hasOverCap) {
                if (!confirm(`警告：以下項目金額超過補助上限，系統將以最高上限計算：\n- ${overCapMessages.join('\n- ')}\n\n確定要提交嗎？`)) {
                    return;
                }
            }


            managedPrograms[programIndex].註冊補助提交狀態 = '待審核';
            managedPrograms[programIndex].提交時間_註冊補助 = new Date().toISOString();
            const allProgramIndex = allPrograms.findIndex(p => p.專班名稱 === programName && p.學期 === semester);
            if (allProgramIndex !== -1) {
                allPrograms[allProgramIndex].註冊補助提交狀態 = '待審核';
                allPrograms[allProgramIndex].提交時間_註冊補助 = managedPrograms[programIndex].提交時間_註冊補助;
            }

            alert(`專班 ${programName} (${semester}) 的註冊與補助資料已提交審核。`);
            renderRegistrationForm();
            renderDashboard();
        }



        function renderNotRegisteredForm() {
            const selectedValue = document.getElementById('nr-program-select').value;
            const contentDiv = document.getElementById('not-registered-content');
            contentDiv.innerHTML = '';

            if (!selectedValue) {
                contentDiv.innerHTML = '<p class="alert alert-info" style="margin-top: 0;">請從上方選擇一個專班以檢視或編輯資料。</p>';
                return;
            }

            const [programName, semester] = selectedValue.split('|');
            const program = findProgram(programName, semester);
            const programStudents = students.filter(s => s.台灣專班名稱 === programName && s.學期 === semester && (s.註冊狀態 === '不註冊' || s.註冊狀態 === '特殊不註冊'));

            if (!program) { contentDiv.innerHTML = '<p class="alert alert-danger">錯誤：找不到專班資料。</p>'; return; }


            let statusHTML = `<div class="info-box"><h4>專班狀態: <span class="${getStatusClass(program.不註冊提交狀態)}">${program.不註冊提交狀態}</span></h4>`;
            if (program.不註冊提交狀態 === '已退回') {
                statusHTML += `<div class="alert alert-danger">退回原因: ${program.退回原因_不註冊 || '無明確原因'}</div>`;
            } else if (program.不註冊提交狀態 === '已通過') {
                statusHTML += `<div class="alert alert-success">此專班不註冊學生資料已審核通過。</div>`;
                const hasOverpayment = programStudents.some(s => s.溢領費用 > 0);
                if (hasOverpayment) {
                    if (program.蓋章清冊檔案_溢領) {
                        statusHTML += `<p style="margin-top: 10px;">已上傳蓋章溢領清冊: <strong>${program.蓋章清冊檔案_溢領}</strong></p>`;
                    } else {
                        statusHTML += `<button id="upload-receipt-btn-nr" class="warning" style="margin-top: 10px;" onclick="openUploadReceiptModal('${programName}', '${semester}', '溢領')"><i class="fas fa-upload"></i> 上傳已蓋章溢領清冊</button>`;
                    }
                } else {
                    statusHTML += `<p style="margin-top: 10px;">(無溢領費用，無需上傳清冊)</p>`;
                }
            } else if (program.不註冊提交狀態 === '待審核') {
                statusHTML += `<div class="alert alert-info">資料已提交，等待管理員審核中...</div>`;
            }
            statusHTML += `</div>`;
            contentDiv.innerHTML += statusHTML;


            const isEditable = (program.不註冊提交狀態 === '待提交' || program.不註冊提交狀態 === '已退回');
            const isOpen = checkOpenTime();
            const finalEditable = isOpen && isEditable;

            if (programStudents.length === 0) {

                if (program.不註冊提交狀態 !== '已通過') {
                    contentDiv.innerHTML += '<p class="alert alert-warning">目前此專班沒有學生被標記為「不註冊」或「特殊不註冊」。請先在「註冊與補助登錄」頁面更新學生狀態。</p>';
                }
                enableEditing(false);
                return;
            }

            let formHTML = `<form id="not-registered-form"><div class="table-container"><table id="not-registered-table"><thead><tr>
                 <th>英文姓名</th><th>護照號碼</th><th>註冊狀態</th><th class="required">原因</th><th>需繳回<br>溢領費用</th>
                 </tr></thead><tbody>`;

            programStudents.forEach((s, index) => {
                const rowId = `nr-student-${s.護照號碼}`;
                let overpayment = 0;
                if (s.註冊狀態 === '不註冊') {


                    overpayment = (s.溢領費用 > 0) ? s.溢領費用 : (10000 + 9000 + 50000);

                    if (findStudent(s.護照號碼)?.溢領費用 !== overpayment) {
                        const studentIdx = students.findIndex(st => st.護照號碼 === s.護照號碼);
                        if (studentIdx > -1) students[studentIdx].溢領費用 = overpayment;
                    }
                } else {
                    overpayment = 0;
                    if (findStudent(s.護照號碼)?.溢領費用 !== 0) {
                        const studentIdx = students.findIndex(st => st.護照號碼 === s.護照號碼);
                        if (studentIdx > -1) students[studentIdx].溢領費用 = 0;
                    }
                }

                formHTML += `<tr id="${rowId}">
                     <td>${s.英文姓名}</td>
                     <td>${s.護照號碼}</td>
                     <td>${s.註冊狀態}</td>
                     <td>
                         <textarea name="未註冊原因_${s.護照號碼}" rows="2" style="width: 95%;" oninput="updateNotRegisteredReason('${s.護照號碼}', this.value)" ${!finalEditable ? 'readonly class="readonly"' : ''} required>${s.未註冊原因 || ''}</textarea>
                     </td>
                     <td><input type="number" class="subsidy-input readonly" value="${overpayment}" readonly></td>
                  </tr>`;
            });

            formHTML += `</tbody></table></div>`;

            if (finalEditable) {
                formHTML += `<div class="sticky-actions action-buttons">
                     <button type="button" id="nr-save-btn" onclick="saveNotRegisteredData('${programName}', '${semester}')" class="warning"><i class="fas fa-save"></i> 暫存</button>
                     <button type="button" id="nr-submit-btn" onclick="submitNotRegisteredData('${programName}', '${semester}')"><i class="fas fa-paper-plane"></i> 提交審核</button>
                 </div>`;
            } else if (!isOpen && isEditable) {
                formHTML += `<div class="alert alert-warning sticky-actions" style="text-align:center;">目前非編輯開放時間，無法儲存或提交。</div>`;
            }

            formHTML += `</form>`;
            contentDiv.innerHTML += formHTML;
            enableEditing(isEditable);
        }

        function updateNotRegisteredReason(passportId, reason) {
            const studentIndex = students.findIndex(s => s.護照號碼 === passportId);
            if (studentIndex !== -1) {
                students[studentIndex].未註冊原因 = reason;
            }
        }

        function saveNotRegisteredData(programName, semester) {
            if (!checkOpenTime()) {
                alert('已超過編輯開放時間，無法暫存。');
                return;
            }

            console.log("Simulating saving non-registered data for:", programName, semester, students);
            alert('不註冊學生原因已暫存 (模擬)。請記得在開放時間內提交審核。');
        }

        function submitNotRegisteredData(programName, semester) {
            if (!checkOpenTime()) {
                alert('已超過編輯開放時間，無法提交。');
                return;
            }

            const programIndex = managedPrograms.findIndex(p => p.專班名稱 === programName && p.學期 === semester);
            if (programIndex === -1) { alert('錯誤：找不到專班資料'); return; }

            const programStudents = students.filter(s => s.台灣專班名稱 === programName && s.學期 === semester && (s.註冊狀態 === '不註冊' || s.註冊狀態 === '特殊不註冊'));
            let hasMissingReason = false;
            programStudents.forEach(s => {
                const textarea = document.querySelector(`textarea[name="未註冊原因_${s.護照號碼}"]`);
                if (!s.未註冊原因 || s.未註冊原因.trim() === '') {
                    hasMissingReason = true;
                    textarea?.classList.add('error');
                } else {
                    textarea?.classList.remove('error');
                }
            });

            if (hasMissingReason) {
                alert('提交失敗：請為所有「不註冊」或「特殊不註冊」的學生填寫原因 (欄位已標紅框)。');
                return;
            }


            managedPrograms[programIndex].不註冊提交狀態 = '待審核';
            managedPrograms[programIndex].提交時間_不註冊 = new Date().toISOString();
            const allProgramIndex = allPrograms.findIndex(p => p.專班名稱 === programName && p.學期 === semester);
            if (allProgramIndex !== -1) {
                allPrograms[allProgramIndex].不註冊提交狀態 = '待審核';
                allPrograms[allProgramIndex].提交時間_不註冊 = managedPrograms[programIndex].提交時間_不註冊;
            }

            alert(`專班 ${programName} (${semester}) 的不註冊學生資料已提交審核。`);
            renderNotRegisteredForm();
            renderDashboard();
        }



        function openUploadReceiptModal(programName, semester, type) {
            if (!checkOpenTime()) {
                alert('已超過編輯開放時間，無法上傳檔案。');
                return;
            }
            currentUploadContext = { programName, semester, type };
            document.getElementById('upload-receipt-program-name').textContent = `${programName} (${semester})`;
            document.getElementById('upload-receipt-type').textContent = type;
            document.getElementById('receipt-file-upload').value = '';
            openModal('upload-receipt-modal');
        }

        function simulateDownloadReceipt() {
            if (!currentUploadContext) return;
            const { programName, semester, type } = currentUploadContext;
            alert(`(模擬) 開始下載 ${programName}_${semester}_${type}清冊.pdf`);
        }

        function submitSignedReceipt() {
            if (!checkOpenTime()) {
                alert('已超過編輯開放時間，無法提交。');
                return;
            }
            if (!currentUploadContext) return;
            const { programName, semester, type } = currentUploadContext;
            const fileInput = document.getElementById('receipt-file-upload');
            const file = fileInput.files[0];

            if (!file) { alert('請選擇要上傳的 PDF 檔案。'); return; }
            if (file.type !== 'application/pdf') { alert('僅能上傳 PDF 檔案。'); return; }
            if (file.size > 5 * 1024 * 1024) { alert('檔案大小超過 5MB 限制。'); return; }

            const programIndex = managedPrograms.findIndex(p => p.專班名稱 === programName && p.學期 === semester);
            if (programIndex === -1) { alert('錯誤：找不到專班資料'); return; }

            const filename = file.name;
            const fieldToUpdate = type === '補助' ? '蓋章清冊檔案_補助' : '蓋章清冊檔案_溢領';
            managedPrograms[programIndex][fieldToUpdate] = filename;

            const allProgramIndex = allPrograms.findIndex(p => p.專班名稱 === programName && p.學期 === semester);
            if (allProgramIndex !== -1) { allPrograms[allProgramIndex][fieldToUpdate] = filename; }

            alert(`檔案 ${filename} 已成功上傳 (模擬)`);
            closeModal('upload-receipt-modal');

            if (type === '補助') { renderRegistrationForm(); }
            else { renderNotRegisteredForm(); }
            renderDashboard();
            currentUploadContext = null;
        }



        window.onload = () => {
            document.getElementById('school-admin-name').textContent = adminUser.school;
            checkOpenTime();
            renderDashboard();

            populateProgramSelect('reg-program-select', 'registration');
            populateProgramSelect('nr-program-select', 'not-registered');
            showSection('dashboard');
        };

    </script>
</body>

</html>